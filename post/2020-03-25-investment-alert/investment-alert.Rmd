---
title: "Desenvolva um bot e receba resultados de Machine Learning no seu Smartphone para ajudar nos investimentos"
author: Fellipe Gomes
date: '2020-03-25'
slug: []
categories:
  - Analise Explorat√≥ria
  - Automa√ß√£o
  - Bitcoin
  - Cloud
  - Estatistica
  - Machine Learning
  - Pr√°tica
  - R
  - Reports
  - RMarkdown
  - S√©ries Temporais
  - Shiny
tags:
  - bitcoin
  - Correlacoes
  - Dplyr
  - Estatistica
  - gomesfellipe
  - machine learning
  - modelagem
  - R
  - reports
  - S√©ries Temporais
  - RStudio
  - Tabelas
  - bolsa de valores
  - prophet
description: 'Entenda a l√≥gica de como montar uma carteira, coletar dados de finan√ßa em tempo real, treinar um modelo de Machine Learning com Prophet (Facebook Open Source) e receber an√°lises automatizadas no Smartphone'
featured: 'img1.png'
featuredalt: 'Pic 24'
featuredpath: 'date'
linktitle: ''
type: "post"
---


<style>
.column {
  float: left;
  width: 50%;
  padding: 10px;
}

.column4 {
  float: left;
  width: 33%;
  padding: 10px;
}

.column8 {
  float: left;
  width: 66%;
  padding: 10px;
}

.row:after {
  content: "";
  display: table;
  clear: both;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, fig.align = "center", fig.width = 10)

# Carregar pacotes:
library(dplyr)         # manipulacao de dados
library(purrr)         # programacao funcional
library(knitr)         # tabela
library(kableExtra)    # formatar tabela
library(formattable)   # extrasformatar tabela
library(prophet)       # ml
library(alphavantager) # api bovespa

AV_API_KEY = Sys.getenv("AV_API_KEY")
av_api_key(AV_API_KEY)

ggplot2::theme_set(ggplot2::theme_bw())

kable2 <- function(x){
  x %>% 
    kable(format = "html", escape = F) %>%
    kable_styling(c("striped", "bordered", "hover", "responsive"), full_width = F) 
}

source("https://raw.githubusercontent.com/gomesfellipe/functions/master/inicio_e_fim_da_base.R")
source("https://raw.githubusercontent.com/gomesfellipe/functions/master/moeda_real.R")
```

# Por que investir?

Como esta sua situa√ß√£o financeira? Caso tenha alguma reserva pode ser interessante pensar em investimentos pois a poupan√ßa j√° n√£o √© mais garantia de lucro no longo prazo, n√£o acredita?

Estamos no final do primeiro trimestre de 2020 e desde 2019 j√° liam-se not√≠cias como esta abaixo que levam √† reflex√£o sobre reeduca√ß√£o financeira pois alertam sobre a necessidade da busca por novas oportunidades de investimento.

<center>![](/post/2020-03-25-investment-alert/investment-alert_files/noticia_poupanca.png){width=50%} <br><small>Fonte: <https://noticias.r7.com/economia/economize/poupanca-em-baixa-exige-busca-por-novos-investimentos-em-2020-25122019></small></center></br>

Com a finalidade de fomentar um pouco a discuss√£o sobre investimentos, trouxe nesse post algumas sugest√µes e id√©ias de como elaborar uma carteira e otimizar as escolhas para equilibrar risco em novos investimentos combinando elementos de estat√≠stica, machine learning e programa√ß√£o em R.

Ao final do post criaremos um [rob√¥ no telegram](https://core.telegram.org/bots) que coletar√° os dados das cota√ß√µes adquiridas, aplicar√° o modelo [Prophet do Facebook](https://facebook.github.io/prophet/docs/quick_start.html) para forecast e analisar√° a desmontagem da carteira segundo os crit√©rios estabelecidos e enviar√° mensagens para n√≥s com uma tabela financeira automatizada via Telegram como mostra na anima√ß√£o:

</br>

<div class="row">
<div class="column4">
<center>![](/post/2020-03-25-investment-alert/investment-alert_files/watch.png)</center> 
</div> 
<div class="column8"> 
![](/post/2020-03-25-investment-alert/investment-alert_files/report_stocks.gif){width=90%}
</div> 
</div>

</br>

<div class="w3-panel w3-pale-red w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>  **AVISO**: Este post **n√£o** tem como finalidade ser um guia de investimentos (J√° existem muitas consultorias especializadas nisso por ai). Todos as decis√µes tomadas como diversifica√ß√£o da carteira, sele√ß√£o de a√ß√µes e crit√©rios para desmontagem da carteira s√£o **exemplos** e servem para ilustrar algumas **possibilidades** que um cientista de dados t√™m na hora de desenvolver ferramentas para auxiliar √† tomada de decis√£o.
</div>



</br>

## Diferen√ßa de poupar e investir

De acordo com um [especialista entrevistado pela InfoMoney](https://www.infomoney.com.br/minhas-financas/brasileiros-nao-sabem-a-diferenca-entre-poupar-e-investir-afirma-especialista-2/): 

> ‚ÄúPoupar √© guardar dinheiro para usar no futuro, comprar alguma coisa com ele. Investimento √© juntar dinheiro, n√£o mexer nele, para que este gere rendimentos e a√≠ sim, usar os lucros mais para frente. √â o recomendado para quem quer viver de renda no futuro, por exemplo‚Äù (...)
<div align="right"><font size="1">InfoMoney - Ago 2015</font></div>

Ou seja, poupar √© acumular agora para utilizar depois, e normalmente envolve mudan√ßa de h√°bitos, pois requer uma redu√ß√£o nos gastos pessoais e familiares, j√° investir √© usar esse dinheiro poupado em aplica√ß√µes que rendam.

Como todo mundo sabe, n√£o existe investimento sem risco e este risco deve ser controlado e utilizado a nosso favor de forma que gere alguma seguran√ßa financeira.

# Montagem da carteira

<div class="row">
<div class="column8">

N√£o colocar todos os ovos na mesma cesta significa que voc√™ deve diversificar o seu investimento. Provavelmente voc√™ j√° ouviu essa frase alguma vez na vida e ela certamente faz sentido! 

Diversificar a carteira ir√° proteger seus investimentos diminuindo o risco pois, imagine s√≥, voc√™ investe todo o seu dinheiro em uma empresa e ela passa por alguma crise assim seu dinheiro estar√° todo comprometido! 

Existem diversos motivos para se diversificar a carteira mas acho que essa met√°fora dos ovos j√° resume bem pois acredito que ningu√©m queira perder tudo em uma queda.

</div> 
<div class="column4">
![](/post/2020-03-25-investment-alert/investment-alert_files/ovos_mesm_cesta.png){width=90%}
</div> 
</div>

## Como dividir a carteira?

Dependendo do risco que voc√™ deseja se expor existem muitas formas de preparar a carteira mas a id√©ias principal consiste em atingir um equil√≠brio entre dois tipos de investimento:

* Renda fixa: Menor exposi√ß√£o, menor risco  (ex.: CDI, Selic e TR)
* Renda vari√°vel: Maior exposi√ß√£o, maior risco (ex: A√ß√µes, Commodities, Im√≥veis)

Para ajudar a dividir a carteira de investimentos neste post utilizaremos a chamada [Regra (ou Lei) dos 80](https://www.btgpactualdigital.com/blog/coluna-gustavo-cerbasi/defina-sua-estrategia-entre-renda-fixa-ou-variavel). A estrat√©gia √© a seguinte: subtraia da sua idade o n√∫mero 80. O resultado dessa conta vai indicar o percentual a ser investido em [renda vari√°vel](https://pt.wikipedia.org/wiki/Renda_vari%C3%A1vel). Por exemplo, no meu caso: tenho 26 anos, portanto $80-26 = 54\%$ dever√° ser investido em renda vari√°vel. Aos 53 anos esse percentual vai cair√° para a metade, $27\%$.

A id√©ias principal por tr√°s desta regra que √© que a cada ano que passa, 1% do montante da renda vari√°vel deva ser direcionado para a [renda fixa](https://pt.wikipedia.org/wiki/Renda_fixa).

Para testar diferentes valores seguindo esta regra desenvolvi uma fun√ß√£o que se chama [`montagem80()` (que j√° est√° dispon√≠vel no github)](https://gist.github.com/gomesfellipe/a74710a63b3c8637166b538ad2f460f5). Vejamos alguns resultados para diferentes cen√°rios e vamos selecionar um para seguir com a montagem da carteira:

```{r}
# https://gist.github.com/gomesfellipe/a74710a63b3c8637166b538ad2f460f5
devtools::source_gist("a74710a63b3c8637166b538ad2f460f5", quiet = T)
```

<div class="row">
<div class="column">
1. Entrada de R$20.000,00 <big>üëà</big>
```{r}
montagem80(entrada = 20000, idade = 26)
```
</div>
<div class="column">
2. R$ 5.000,00 em acoes 
```{r}
montagem80(variavel = 10800, idade = 53)
```
</div>
</div>

Utilizaremos a primeira (1.) configura√ß√£o que esta assinalada em vermelho como exemplo, onde:

* Entrada: `r moeda_real(montagem80(entrada = 20000, idade = 26, return = T)[1])`
* Renda fixa: `r moeda_real(montagem80(entrada = 20000, idade = 26, return = T)[2])`
* Renda Vari√°vel (Acoes): `r moeda_real(montagem80(entrada = 20000, idade = 26, return = T)[3]*.9)`
* Renda Vari√°vel (Crypt): `r moeda_real(montagem80(entrada = 20000, idade = 26, return = T)[3]*.1)` 

Note que a entrada deve ser o dobro na segunda (2.) configura√ß√£o caso deseje investir `r moeda_real(10800)` (que √© o valor sugerido aos 26 anos para uma entrada de `r moeda_real(20000)`) 

Ap√≥s definir a quantidade a ser investida √© hora de planejar a pr√≥xima etapa: a diversifica√ß√£o.


## Diversifica√ß√£o da carteira

<div class="row">
<div class="column8">

A diversifica√ß√£o √© uma t√©cnica para gest√£o do risco que visa distribuir o capital investido em uma variedade de investimentos dentro de da nossa carteira.

Assim, o risco do portf√≥lio √© consideravelmente reduzido pois reduzimos a volatividade e criamos um equil√≠brio onde um desempenho positivo de um ativo neutraliza as baixas ocorridas em outras aplica√ß√µes. Al√©m disso a diversifica√ß√£o pode ser tanto coma renda vari√°vel quanto com a renda fixa.

Mas lembre-se, n√£o existe uma receita mais eficiente! 

</div> 
<div class="column4">
</br>
<iframe src="https://giphy.com/embed/qJkRbWM1MfVjq" width="100%" height="150" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/eggs-qJkRbWM1MfVjq">via GIPHY</a></p>
</div> 
</div>

### Renda fixa

Normalmente, tamb√©m diversificamos nossa renda fixa por√©m como gostaria de focar nas an√°lises de renda vari√°vel utilizaremos o simulador dispon√≠vel no site <https://verios.com.br/> neste [link](https://simulador-tesouro-direto.verios.com.br/) para selecionar apenas um t√≠tulo:

<center>
![](/post/2020-03-25-investment-alert/investment-alert_files/tesouro_direto.png){width=80%}
<small></br>Fonte: <https://simulador-tesouro-direto.verios.com.br/></small>
</center>
</br>

Como exemplo, escolhi o Tesouro Prefixado 2015 (LTN), note que com essa escolha o lucro planejado seria de quase 3 mil reais nos pr√≥ximos 5 anos.

<div class="w3-panel w3-pale-red w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **AVISO**: Lembrando que esta sele√ß√£o √© apenas um exemplo e existem diversas informa√ß√µes a serem levadas em conta ao se fazer esta escolha al√©m de se poder diversificar tamb√©m. Convido o leitor a procurar saber mais sobre os tipos, pr√≥s e contras do Tesouro Direto.
</div>

### Renda vari√°vel

Para elabora√ß√£o da parte da renda vari√°vel da carteira selecionei duas a√ß√µes que s√£o inversamente correlacionadas (de forma totalmente arbitr√°ria)  baseado no excelente post \"[Estudo de correla√ß√£o entre a√ß√µes da Bolsa de Valores de S√£o Paulo](https://www.tradingcomdados.com/post/2017/07/09/estudo-de-correla%C3%A7%C3%A3o-entre-a%C3%A7%C3%B5es-da-bolsa-de-valores-de-s%C3%A3o-paulo)\" escrito por Victor Gomes onde o autor faz um estudo de correla√ß√µes das s√©ries hist√≥ricas de a√ß√µes de diferentes setores.

Al√©m disso, o Bitcoin ser√° selecionado para completar a carteira de renda vari√°vel como um ativo de alto risco com bastante volatividade. Mas voc√™ deve estar se perguntando, por que assumir este risco? 

Existem muitas hist√≥rias de pessoas que ficaram milion√°rias com o Bitcoin pela sua valoriza√ß√£o inesperada ao longo do tempo, como por exemplo o [adolescente que ficou milion√°rio aos 18 anos usando bitcoins ap√≥s fazer aposta com os pais](https://www.infomoney.com.br/mercados/adolescente-fica-milionario-aos-18-anos-usando-bitcoins-apos-fazer-aposta-com-os-pais/).  

Ent√£o **eu** acho que 10% dessa nossa carteira (n√£o esque√ßa que podemos ter mais de uma carteira) √© um risco que pode valer a pena correr e por isso vou inclu√≠-lo.

Portanto, para este exemplo consideramos:

* TUPY3.SA: [Tupy](https://www.google.com/search?q=tupy3&oq=tupy3&aqs=chrome..69i57.7273j0j4&sourceid=chrome&ie=UTF-8)
* ELET3.SA: [Centrais Eletricas Brasileiras SA](https://www.google.com/search?ei=-dxuXtuyNIbR5OUPxY2m8AE&q=ELET3.SA&oq=ELET3.SA&gs_l=psy-ab.3..0.40045.41040..41701...0.2..0.123.237.0j2......0....2j1..gws-wiz.......0i71.a2fjObIM6cM&ved=0ahUKEwibk86a8p3oAhWGKLkGHcWGCR4Q4dUDCAs&uact=5)
* BTC-USD: [Bitcoin](https://www.google.com/search?ei=JN1uXsDJLJm55OUPj8-c8As&q=bitcoin&oq=bitcoin&gs_l=psy-ab.3.0.0i131i70i258j0i131i67j0i131j0i67j0j0i67j0i131j0i67j0j0i131.25383.26281..27215...0.0..0.175.1147.1j8......0....1..gws-wiz.xu0EQx1CnXI) 

```{r}
portifolio = c("TUPY3.SA","ELET3.SA", "BTC-USD")
```

<div class="w3-panel w3-pale-red w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **AVISO**: Volto a frisar que as escolhas das a√ß√µes foram feitas de forma arbitr√°ria. Estamos em tempos de incerteza atualmente por conta do corona v√≠rus (espero que todos fiquem bem) o que leva algumas escolhas √† serem ainda mais complexas e imprevis√≠veis. 
</div>

#### Obter dados

A aquisi√ß√£o das s√©rie hist√≥ricas das cota√ß√µes destes ativos desde 01/01/2016 foram obtidas utilizando o pacote [`tidyquant`](https://github.com/business-science/tidyquant) que nos retorna os dados das cota√ß√µes das a√ß√µes informadas em formato "arrumado" (ou seja, familiar com fun√ß√µes do [tidyverse](https://www.tidyverse.org/)), veja:

```{r, eval = T}
library(tidyquant) # aquisicao de dados financeiros
stocks <-map_df(portifolio, ~tq_get(.x, get = "stock.prices", from = " 2016-01-01"))
saveRDS(stocks, "stocks.rds")
```

```{r, echo = F, eval = T}
stocks <- readRDS("stocks.rds")
```

Veja as linhas iniciais do dataset obtido:

```{r}
stocks %>% head() %>% kable2()
```

Existem uma s√©rie de vantagens de se trabalhar com os dados neste formato em R, veremos o porque nas pr√≥ximas se√ß√µes.

#### Arrumar dataset

O formato  [`tsibble`](https://github.com/tidyverts/tsibble) √© um formato moderno para se trabalhar com s√©ries temporais trazendo a filosofia do `tidyverse` para os dados de s√©ries temporais facilitando o  [fluxo de trabalho](https://blog.earo.me/2018/12/20/reintro-tsibble/). 

Diversos outros pacotes podem ser combinados utilizando os dados no formato do pacote `tsibble` como os pacotes [`fable`](https://robjhyndman.com/hyndsight/fable/) e o [`prophet`](https://github.com/mitchelloharawild/fable.prophet) (sugiro a leitura para quem nao conhece) para aplica√ß√£o de modelagem de s√©ries temporais.

Veja como √© o fluxo ao trabalhar com objetos do tipo `tsibble`

<center>
![](/post/2020-03-25-investment-alert/investment-alert_files/ds-pipeline.png){width=60%}
</br>
<small>Fonte: <https://blog.earo.me/2018/12/20/reintro-tsibble/></small>
</center>

</br>

```{r}
library(tsibble) # series temporais arrumadas
tbl_stocks <- stocks %>% as_tsibble(key = symbol, index = date) 
```

Ap√≥s importar e arrumar o dataset, seguimos para os pr√≥ximos passos.

#### Transformar

Ap√≥s converter para `tsibble`, vamos preencher alguns gaps da bolsa como por exemplo os finais de semana (quando a bolsa de valores fica fechada) com o mesmo valor do dia anterior (Para este exemplo vamos fazer esse preenchimento dos gaps do final de semana mas n√£o √© sempre √© necess√°rio):

```{r}
tbl_stocks <- 
  tbl_stocks %>% 
  fill_gaps() %>% 
  tidyr::fill(c(open, high, low, close, volume, adjusted),.direction = "down")
```

Com os dados arrumados vamos a algumas visualiza√ß√µes.

#### Visualizar

Vejamos qual foi o comportamento das s√©ries hist√≥ricas que coletamos desde o in√≠cio de 2016:

```{r}
library(forecast) # series temporais
library(fpp3)     # series temporais
d2 <- 
  tbl_stocks %>% 
  group_by(symbol) %>% 
  summarise(y = mean(close))

autoplot(tbl_stocks)+
  geom_line(aes(group = symbol), color = "black", show.legend = F) + 
  facet_wrap(~symbol, scales = "free_y", ncol = 1)+
  geom_ma(n=6*30, color = "red") + 
  theme(legend.position = "none")+
  labs(subtitle = "m√©dia m√≥vel n = 6 meses",
       caption = "gomesfellipe.github.io")
```

Note que a s√©rie do Bitcoin √© a mais imprevis√≠vel, houve um pico em 2018 mas ap√≥s isso n√£o houve nenhum grande pico como aquele. Em breve ocorrer√° o [Halving](https://www.infomoney.com.br/onde-investir/halving-conheca-o-processo-que-pode-levar-o-bitcoin-a-uma-nova-explosao-de-preco/) (a contagem regressiva pode acompanhada [neste link](https://www.bitcoinblockhalf.com/)) que √© um processo de choque de oferta e ocorre aproximadamente a cada 4 anos e pode ser uma boa oportunidade de retorno.

As duas s√©ries da bolsa de valores n√£o parecem ter uma correla√ß√£o muito forte, os picos ocorrem de forma alternada e isto pode ser uma caracter√≠stica boa para a carteira pois caso uma delas entre em crise a outra poder√° estar em uma fase boa.

<div class="w3-panel w3-pale-blue w3-border">
<i class="fa fa-ambulance" aria-hidden="true"></i>  Nota: Esta queda abrupta que ocorreu na bolsa no in√≠cio de 2020 √© o reflexo da [Pandemia CODVID-19](https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_no_Brasil) que j√° come√ßou a apresentar alguns casos no Brasil e isso certamente tem gerando muita incerteza na bolsa de valores. Nem eu nem ningu√©m sabe o que pode acontecer, estou na torcida para que todos fiquem bem e pelo sucesso na conten√ß√£o desse v√≠rus! <i class="fas fa-praying-hands"></i> 
</div>

#### Correla√ß√µes

Para estudar melhor as conjecturas formadas ao observar o comportamento das s√©ries hist√≥rias (de que os picos e vales se alternam) vamos conferir olhada nos gr√°ficos de dispers√£o e coeficientes de [correla√ß√£o de Spearman](https://pt.wikipedia.org/wiki/Coeficiente_de_correla%C3%A7%C3%A3o_de_postos_de_Spearman):

```{r, fig.height=4, fig.width=5, fig.align="center"}
points_loess <- function(data, mapping){
  ggplot(data = data, mapping = mapping) + 
    geom_point(alpha = 0.3,size=0.5) + 
    geom_smooth(method = "loess")
}

tbl_stocks %>%
  as_tibble() %>% 
  select(symbol, date, close) %>% 
  spread(key = symbol, value = close) %>%
  GGally::ggpairs(columns = 2:4,
                  upper = list(continuous = GGally::wrap("cor", method = "spearman")),
                  lower = list(continuous =  points_loess))
```

Note que a rela√ß√£o entre TUPY3 e ELET3 n√£o √© linear e al√©m disso essa correla√ß√£o √© fraca, o que pode ser ben√©fico para o portf√≥lio pois uma poss√≠vel queda em uma n√£o parece n√£o ter tanto impacto na outra.

Al√©m disso note que a correla√ß√£o do BTC-USD com TUPY3 e ELET3 √© moderada e mesmo apresentando este valores num√©ricos, o Bitcoin √© um ativo negociado em escala global e √© de um setor totalmente diferente das outras a√ß√µes.

<div class="w3-panel w3-pale-red w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **AVISO**: Essa an√°lise meramente num√©rica n√£o √© o suficiente para detectar uma rela√ß√£o de causa, pois correla√ß√£o n√£o implica causalidade. Isto que dizer que poda haver uma causa em comum para ambas ou que seja uma [correla√ß√£o esp√∫ria](https://pt.wikipedia.org/wiki/Regress%C3%A3o_esp%C3%BAria). Quando se trata da bolsa de valores √© necess√°rio tamb√©m conhecer um pouco sobre a situa√ß√£o e hist√≥ria da empresa na qual se investe.
</div>

#### Forecast com Prophet do Facebook

Poder√≠amos utilizar uma s√©rie de modelos estat√≠sticos, econom√©tricos e de machine learning utilizando tanto as fun√ß√µes nativas do R base ou pacote forecast quanto as fun√ß√µes desenvolvidas para trabalhar de maneira "arrumada" com tsibble mas resolvi fazer uma abordagem diferente neste post escolhendo o modelo disponibilizado pelo Facebook.

<div class="row">
<div class="column">
</br>
O [Prophet](https://facebook.github.io/prophet/) √© um software de c√≥digo aberto disponibilizado pela equipe de [Data Science do Facebook](https://research.fb.com/category/data-science/) que fornece um procedimento para realiza√ß√£o de previs√µes de dados de s√©ries temporais.

</div>
<div class="column"> 
![](/post/2020-03-25-investment-alert/investment-alert_files/prophet_logo.png){width=80%}
</br><small>Fonte: <https://facebook.github.io/prophet/></small>
</div> 
</div>

Segundo a [documenta√ß√£o oficial](https://facebook.github.io/prophet/), (em tradu√ß√£o livre): 

> O Prophet tem como "base em um modelo aditivo no qual tend√™ncias n√£o lineares se ajustam √† sazonalidade anual, semanal e di√°ria, al√©m de efeitos de f√©rias. Funciona melhor com s√©ries temporais que t√™m fortes efeitos sazonais e v√°rias temporadas de dados hist√≥ricos. O Profeta √© robusto para a falta de dados e mudan√ßas na tend√™ncia, e geralmente lida bem com outliers".

Este modelo me pareceu uma boa op√ß√£o para exemplificar a etapa da modelagem de s√©ries temporais deste post. Vamos ver o que o modelo do Facebook tem a nos dizer sobre o futuro das nossas a√ß√µes.

##### Divis√£o entre treino e teste em s√©ries temporais

Assim como em uma tarefa de machine learning que n√£o envolvem dados temporais, no caso de s√©ries temporais, quando desejamos avaliar o ajuste do nosso modelo tamb√©m dividimos o dataset em treino e teste por√©m utilizamos a data como √≠ndice.

```{r, echo = F}
h = 30 * 2
data_split <- Sys.Date() - h
```

Veja como ser√£o divididas nossas s√©ries hist√≥ricas: 

* treino: inicio da s√©rie at√© `r format(data_split, "%d/%m/%y")`;
* teste: de `r format(data_split, "%d/%m/%Y")` at√© o final da s√©rie hist√≥rica (2 meses atr√°s)

```{r}
h = 30 * 2
data_split <- Sys.Date() - h

tbl_stocks_train <-  
  tbl_stocks %>% 
  filter(date <= data_split) %>% 
  select(symbol, date, close)

tbl_stocks_test <- 
  tbl_stocks %>%
  filter(date > data_split) %>% 
  select(symbol, date, close)
```

Ap√≥s dividir os dados em treino e teste j√° estamos habilitados √† utilizar o modelo. Note que, por default, o modelo espera duas colunas nomeadas como `ds`: data da s√©rie e `y`: vari√°vel target da s√©rie.

Al√©m disso faremos uma previs√£o 6 meses a frente dos dados de teste para entender qual a tend√™ncia o modelo estaria adotando.

```{r}
library(prophet)

prophet_results <- 
  tbl_stocks_train %>% 
  rename(ds = date, y = close) %>% 
  nest(data = c(ds, y)) %>% 
  mutate(pmodel = map(data, ~ prophet(.x, daily.seasonality=TRUE))
  )%>% 
  mutate(pprediction = map(pmodel, ~.x %>%  
                             make_future_dataframe(periods = h + 30*6) %>%
                             predict(.x,.))) 
```

Veja os resultados do ajuste do modelo:

```{r, fig.height=7}
library(patchwork)

pmap(list(
  x = prophet_results$pprediction,
  y = split(tbl_stocks_train, tbl_stocks_train$symbol),
  z = split(tbl_stocks_test, tbl_stocks_test$symbol),
  w = prophet_results$symbol
),function(x, y, z, w){
  x %>% 
    as_tibble() %>%
    mutate(ds=as_date(ds)) %>%
    select(ds, trend, yhat, yhat_lower, yhat_upper) %>% 
    ggplot() + 
    geom_line(aes(x=ds, y=yhat, color="blue"), show.legend = F) +
    geom_line(data=y, aes(x=date, y=close, color="black"), show.legend = F) +
    geom_line(data=z, aes(x=date, y=close, color="red"), show.legend = T) +
    geom_ribbon(aes(x=ds, ymin=yhat_lower, ymax=yhat_upper), alpha=0.2)  +
    scale_x_date(#limits = c(as.Date("2018-06-01"), Sys.Date() + 30*12), 
      date_breaks = "6 month", date_labels = "%m/%Y") +
    theme_bw()+
    labs(y = w, x = "", caption = "gomesfellipe.github.io")+
    scale_colour_manual(values=c("black","blue","red"), name="", labels=c("treino","modelo","teste"))+
    theme(legend.position = c(1-0.8,1-0.2), 
          legend.background = element_rect(fill=alpha('lightgrey', 0.2)),
          legend.direction = "horizontal")
}
) %>% {.[[1]] / .[[2]] / .[[3]]}

ggsave("phophet.png") # salvar para o bot retornar este resultado!
```

Parece interessante..

Veja que a linha azul (modelo ajustado) se ajusta bem √† linha preta (dados de treino) acompanhando a s√©rie hist√≥rica e captando algumas tend√™ncias n√£o lineares. 

Por√©m note que a linha azul se perde completamente da linha vermelha (dados de teste) no in√≠cio de 2020 e acho isso muito razo√°vel pois dificilmente algum modelo iria prever os efeitos de uma Pandemia utilizando apenas a s√©rie hist√≥rica do ativo.

Note ainda que a linha azul se estende at√© o final de 2020 (previs√µes para os pr√≥ximos 6 meses) o que sugere que a s√©rie possu√≠a esta tendencia positiva ao longo dos anos, segundo o modelo Prophet .

<div class="w3-panel w3-pale-yellow w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **Aviso**: Existem v√°rias maneiras de estudar e melhorar a qualidade do ajuste deste modelo mas como o objetivo deste post n√£o √© este deixo como aviso para o leitor.
</div>

Com a interpreta√ß√£o dos resultados conclu√≠da.. vamos √†s compras!

# Comprando a√ß√µes

Ap√≥s toda essa exemplifica√ß√£o de como podem ser feitas as an√°lises para a elabora√ß√£o da carteira chegou a hora das compras.

Suponha que tiv√©ssemos realizado nossas compra no fechamento do dia **2018-12-01**, quando os valores de <font color="blue">**fechamento**</font> das cota√ß√µes eram as seguintes:

```{r}
tbl_stocks %>% 
  filter(date == "2018-12-01") %>% 
  mutate(close = cell_spec(moeda_real(close), "html", color = "blue", bold = T)) %>% 
  mutate_at(c(3:5, 8), ~moeda_real(.x)) %>% 
  kable2()

```

```{r, echo = F}
cot_inicio = filter(tbl_stocks, date == "2018-12-01", symbol != "BTC-USD") %>% pull(close)
qtd_inicio = c(elet = 200, tupy = 150)
```

Neste dia a cota√ß√£o para ELET3 era `r moeda_real(cot_inicio)[1]` e TUPY3 era `r moeda_real(cot_inicio)[2]` e suponha que tenhamos comprado `r qtd_inicio[1]` lotes de ELET3 e `r qtd_inicio[2]` fracion√°rios de TUPY, totalizando `r moeda_real(sum(qtd_inicio * cot_inicio))` (pr√≥ximo ao que tinhaamos planejado no inicio do estudo)

Vamos guardar estes valores:

```{r}
cot_inicio = filter(tbl_stocks, date == "2018-12-01", symbol != "BTC-USD") %>% pull(close)
qtd_inicio = c(elet = 200, tupy = 150)
```

Note que o valor do Bitcoin est√° em d√≥lares, para obter o valor em reais (R$) daquele dia vamos utilizar a [API do Mercado Bitcoin](https://www.mercadobitcoin.net/api/BTC/day-summary/2020/01/09/). Como n√£o existe nenhum pacote que forne√ßa estes dados diretamente no R, a requisi√ß√£o ser√° feita normalmente via API com o pacote `jsonlite`:

```{r}
library(jsonlite) # requisicao de api
url <- glue::glue("https://www.mercadobitcoin.net/api/BTC/day-summary/2019/12/01/")
safe_fromJSON <- purrr:::safely(fromJSON, as.numeric(NA)) 
consulta <- safe_fromJSON(url)$result %>% map_dfc(~.x)

consulta %>%
  select(-date) %>% 
  mutate_all(~moeda_real(.x)) %>%
  mutate(closing = cell_spec(closing, "html", color = "blue")) %>% 
  kable2()
```

O pre√ßo de fechamento foi de `r moeda_real(consulta$closing)` e suponhamos que tenha sido este o valor pago no dia. (Parece que neste dia o d√≥lar estava em torno de `r moeda_real(consulta$closing / (tbl_stocks %>% filter(date == "2020-01-09") %>% pull(close) %>% .[1]))`)

Para completar esta carteira fict√≠cia vamos adquirir 0,0032 do valor de um Bitcoin

```{r}
cot_inicio[3] <- consulta$closing
qtd_inicio[3] <- 0.032
```

Portanto, ao valor de `r moeda_real(cot_inicio[3])` compramos `r qtd_inicio[3]` Bitcoin totalizando `r moeda_real(cot_inicio[3] * qtd_inicio[3])` completando nossa carteira.

## Tabela financeira

Semelhante a uma planilha financeira, criaremos uma tabela financeira automatizada que receber√° como input os valores da montagem e calcular√° automaticamente os valores do desmontagem no tempo atual utilizando dados de APIs abertas.

> ‚ÄúAquilo que n√£o se pode medir, n√£o se pode melhorar‚Äù.
<div align="right"><font size="1">F√≠sico irland√™s William Thomson</font></div>

Primeiro √© necess√°rio obter os valores mais recentes das cota√ß√µes das acoes que compramos na bolsa e para isto ser√° necess√°rio utilizar outro pacote pois o `tidyquant` s√≥ fornece os dados em frequ√™ncia di√°ria.

Utilizaremos portanto, o pacote [alphavantager](https://www.business-science.io/code-tools/2017/09/03/alphavantager-0-1-0.html) que fornece dados de finan√ßas da API gratuita [Alpha Vantage](https://www.alphavantage.co/) no formato arrumados e tamb√©m foi desenvolvida pela [Business Science](https://github.com/business-science) (mesmo criados do pacote `tidyquant`).

<div class="w3-panel w3-pale-yellow w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **Aviso**: Na [documenta√ß√£o da api do Alphavantage](https://www.alphavantage.co/support/#api-key) recomenda-se a solicita√ß√µes de API com modera√ß√£o, suportando at√© 5 solicita√ß√µes de API por minuto e 500 solicita√ß√µes por dia para obter o melhor desempenho no servidor. Caso deseje segmentar um volume maior de chamadas da API, confira a [associa√ß√£o premium.](https://www.alphavantage.co/premium/).
</div>

J√° para a coleta da cota√ß√£o em tempo real do Bitcoin em reais (R$), utilizaremos novamente a [api do mercado bitcoin](https://www.mercadobitcoin.com.br/api-doc/?).

```{r, eval = F}
# Importar dados da bolsa de valores ==================================

library(alphavantager) # api streaming bovespa

AV_API_KEY = Sys.getenv("AV_API_KEY")
av_api_key(AV_API_KEY)

consulta_acoes <- map_df(portifolio[1:2], ~{
  alphavantager::av_get(symbol = .x,
         av_fun = "TIME_SERIES_INTRADAY",
         interval = "1min",  # "1min", "5min", "15min", "30min" ou "60min"
         outputsize = "compact") %>%  # "full"
    bind_cols(stock = rep(.x, nrow(.)))
})

# Impotar dados do bitcoin ============================================

coin <- "BTC"
method <- "ticker"
url <- glue::glue("https://www.mercadobitcoin.net/api/{coin}/{method}/")

safe_fromJSON <- safely(fromJSON, as.numeric(NA)) 
consulta_bitcoin <- 
  safe_fromJSON(url)$result$ticker %>% 
  as_tibble() %>% 
  transmute(timestamp = lubridate::ymd_hms(as.POSIXct(date, origin="1970-01-01")),
            open, high, low, close = sell, volume = NA, stock = "BTC.BR") %>% 
  mutate_at(c('open', 'high', 'low', 'close'), ~as.numeric(.x))

# Combinar resultados das consultas ==================================

consulta_atual <- 
  bind_rows(
    consulta_acoes %>% 
      group_by(stock) %>% 
      filter(timestamp == last(timestamp)),
    consulta_bitcoin
  ) 

# Salvar consulta ====================================================
saveRDS(consulta_atual, "consulta_atual.rds")
```

```{r, echo = F, eval = T}
consulta_atual <- readRDS("consulta_atual.rds")
```

Resultados da consulta atual (ap√≥s combinar a requisi√ß√£o da bolsa de valores e do Mercado Bitcoin):

```{r}
consulta_atual  %>%
  mutate_at(2:4, ~moeda_real(.x)) %>% 
  mutate_if(is.numeric, ~ifelse(is.na(.x), "-", format(.x, digits = 2))) %>% 
  mutate(close = cell_spec(moeda_real(close), "html", color = "blue")) %>% 
  kable2()
```

Com os valores da Montagem organizados e os valores da Desmontagem coletados em tempo real j√° podemos construir nossa tabela financeira automatizada. 

A tabela cont√©m:

* Valores de cota√ß√£o e quantidade adquiridas de cada uma no momento da montagem da carteira;
* Valores de cada cota√ß√£o no momento atual com suas respectivas quantidades dispon√≠veis;
* Resultados de o ganho (ou perda) seguido do resultado bruto caso realize a venda agora;
* √öltima coluna indica se vale a pena vender ou n√£o aquela cota√ß√£o considerando que o valor de venda √© superior ao valor de compra.

<div class="w3-panel w3-pale-yellow w3-border">
<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> **Aviso**: Essa opera√ß√£o de vender o ativo caso o pre√ßo da venda seja maior que o da compra √© apenas um exemplo. Poder√≠amos utilizar diversas estat√≠sticas para determinar o momento da opera√ß√£o por√©m adotei esta apenas para ilustrar o funcionamento da tabela financeira, o limite de op√ß√µes √© a sua criatividade!
</div>

Veja a tabela final com os resultados atualizados em tempo real:

```{r}
porcentagem <- function(x){paste0(round(x,2), "%")} # Funcao auxiliar

# Tabela resultado
financas <- 
  tibble(
    ativo = portifolio,
    cot_inicio = cot_inicio,
    qtd_inicio = qtd_inicio,
    vol_inicio = cot_inicio * qtd_inicio,
    cot_atual = consulta_atual$close,
    qtd_atual = qtd_inicio,
    vol_atual = cot_atual * qtd_atual,
    ganho_perda = vol_atual - vol_inicio,
    resultado_bruto = ganho_perda / vol_inicio * 100
  ) 


tabela <- 
  financas %>% 
  mutate(
    cot_inicio = moeda_real(cot_inicio),
    cot_atual = moeda_real(cot_atual),
    vol_inicio = moeda_real(vol_inicio),
    vol_atual = moeda_real(vol_atual),
    qtd_inicio = round(qtd_inicio,4),
    qtd_atual = round(qtd_atual,4),
    ` ` = ifelse(ganho_perda > 0,"\u2713", "\u2718") ,
    cot_atual = cell_spec(cot_atual, "html", color = "blue"),
    ganho_perda = cell_spec(moeda_real(ganho_perda), "html",
                            color = ifelse(ganho_perda > 0, 
                                           "green", "red")),
    resultado_bruto = cell_spec(porcentagem(resultado_bruto), "html",
                                color = ifelse(resultado_bruto > 0, 
                                               "green", "red"))) %>% 
  `colnames<-`(stringr::str_replace_all(colnames(.), "(_|[[:space:]])", "\n")) %>% 
  # Exibicao
  kable(format = "html", escape = F) %>%
  kable_styling(c("striped", "bordered", "hover", "responsive"), full_width = T, font_size = 12) %>%
  add_header_above(c(" ", "Montagem" = 3,
                     "Desmontagem / Atual" = 3, "Resultado" = 3))

tabela
```

Agora que j√° possu√≠mos nossa requisi√ß√£o completa e arrumada em tempo real precisamos ter acesso a esta informa√ß√£o de forma din√¢mica tamb√©m e para isso utilizaremos o bot do Telegram.

# Bot Telegram

Depois de muitas decis√µes tomadas enfim chegamos ao bot! Espero que tenha notado que montar uma carteira n√£o √© uma tarefa f√°cil pois envolve exposi√ß√£o ao risco e tamb√©m exige certo acompanhamento do mercado.

<div class="row">
<div class="column8">
</br>
Para criar um bot no Telegram basta seguir os passos do [readme](https://github.com/lbraglia/telegram) do pacote [`telegram`](https://github.com/lbraglia/telegram) disponibilizado no Github ou seguir os passos desse excelente [post do curso-r](https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/) que me inspirou a uns anos atras e hoje me auxiliou novamente para criar este bot. Ao concluir a etapa de configura√ß√£o teremos um novo contado no Telegram, o nosso bot!

Com a configura√ß√£o no aplicativo do Telegram conclu√≠da, o primeiro passo para configurar as a√ß√µes do bot no R √© iniciar um objeto TGBot declarando o id do seu bot. No meu caso o bot se chama *Stocks* e o id √© *fgstockbot*.
</div>
<div class="column4">
</br>
<center>![](/post/2020-03-25-investment-alert/investment-alert_files/bot_telegram.png){width=99%}</center>
</div>
</div>

Com o R conectado ao bot do Telegram j√° somos capazes de criar um conjunto de regras de forma que o bot nos retorne as informa√ß√µes que desejamos. 

Desenvolveremos a fun√ß√£o `report_stocks()` que programa o bot para realizar o seguinte algoritmo:

0. Carregar depend√™ncias e conectar chaves de acesso
1. Conferir se a bolsa de valores esta aberta 
2. Requisi√ß√£o das cota√ß√µes da bolsa de valores em *real-time*
3. Requisi√ß√£o da cota√ß√£o do Bitcoin em *real-time*
4. Combinar resultados
5. Inserir resultados da coleta na tabela financeira
6. Se o valor de algum volume atual seja maior que o volume inicial:
    * Calcular valores de desmontagem
    * Preparar layout da tabela financeira
    * Salvar resultados 
    * Enviar via Telegram
7. Aguardar 20 minutos para a pr√≥xima requisi√ß√£o
8. Repetir todo o processo

Parece complicado mas √© tranquilo pois todos os c√≥digos de cada uma destas tarefas j√° foram desenvolvidos nas se√ß√µes anteriores e ser√£o apenas combinados. A fun√ß√£o [`report_stocks()` j√° esta  dispon√≠vel no github](https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929), veja a baixo:

(A frequ√™ncia adotata como default pela fun√ß√£o tenta fazer a requisi√ß√£o com a maior frequ√™ncia poss√≠vel na api do Alphavantage)

<script src="https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929.js"></script>

Ap√≥s todas as devidas configura√ß√µes, basta carregar a fun√ß√£o e executar para obter o seguinte resultado:

```{r, eval = F}
# https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929
devtools::source_gist("357af0735d2aedca60146a7655e33929",quiet = T)

# Executar
bot_report_stocks(portifolio = portifolio, 
                  cot_inicio = cot_inicio,
                  qtd_inicio = qtd_inicio)
```

<center>![](/post/2020-03-25-investment-alert/investment-alert_files/report_stocks.gif){width=70%}</center>
</br>
E assim obtemos um feedback atrav√©s do nosso Smartphone ou Smartwatch em tempo real sobre o desempenho da nossa carteira! 

# Conclus√£o e pr√≥ximos passos

Neste post criamos um bot que coleta os dados e faz an√°lises disponibilizando-as em tempo real no Telegram. Por√©m vimos tamb√©m o qu√£o dif√≠cil pode ser a montagem de uma carteira e as an√°lises envolvendo s√©ries hist√≥ricas de ativos. 

Diante dos resultados obtidos aqui existe uma grande gama de op√ß√µes de inova√ß√µes para trabalhos futuros como:

* Programar o bot para responder a uma [menssagem r√°pida no smartwatch](https://support.apple.com/pt-br/guide/watch/apd92a90f882/watchos) com o valor de uma previs√£o;
* Desenvolver um Shiny parametrizando o bot para consultar an√°lises em tempo real;
* Hospedar a rotina em um servidor para operacionalizar o bot (caso tenha d√∫vidas de como se iniciar um RStudio Server u um Shiny Server [consulte este post do blog](https://gomesfellipe.github.io/post/2018-10-27-server-cloud/server-cloud/));
* Criar uma API com [plumber](https://www.rplumber.io) para fornecer os resultados;
* Treinar modelo utilizando mais dados, mais vari√°veis explicativas e tuning dos par√¢metros;
* Criar pacote com um rob√¥ mais geral para responder diferentes consultas.

Espero que tenha gostado qualquer d√∫vida deixe nos coment√°rios!

# Refer√™ncias

* <https://www.infomoney.com.br/minhas-financas/brasileiros-nao-sabem-a-diferenca-entre-poupar-e-investir-afirma-especialista-2/>
* <https://www.btgpactualdigital.com/blog/investimentos/diversificacao-de-investimentos>
* <https://www.btgpactualdigital.com/blog/coluna-gustavo-cerbasi/defina-sua-estrategia-entre-renda-fixa-ou-variavel>
* <https://blog.earo.me/2018/12/20/reintro-tsibble/>
* <https://www.tradingcomdados.com/post/2017/07/09/estudo-de-correla%C3%A7%C3%A3o-entre-a%C3%A7%C3%B5es-da-bolsa-de-valores-de-s%C3%A3o-paulo>
* <https://www.business-science.io/code-tools/2017/10/28/demo_week_h2o.html>
* <https://www.infomoney.com.br/mercados/adolescente-fica-milionario-aos-18-anos-usando-bitcoins-apos-fazer-aposta-com-os-pais/>
* <https://www.infomoney.com.br/onde-investir/halving-conheca-o-processo-que-pode-levar-o-bitcoin-a-uma-nova-explosao-de-preco/>
* <https://cran.r-project.org/web/packages/telegram/README.html>
* <https://otexts.com/fpp2/>
<https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/>
* <https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/>