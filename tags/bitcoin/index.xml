&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>bitcoin on Fellipe Gomes - Data Science Blog</title>
    <link>https://gomesfellipe.github.io/tags/bitcoin/</link>
    <description>√öltimos posts sobre Data Science, Machine Learning e R</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>pt-br</language>
    <managingEditor>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</managingEditor>
    <webMaster>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</webMaster>
    <lastBuildDate>Sun, 04 May 2025 00:00:00 +0000</lastBuildDate>
    <atom:link href="https://gomesfellipe.github.io/tags/bitcoin/" rel="self" type="application/rss+xml" />
    <item>
      <title>Construindo uma Equipe Multiagente de IA para An√°lise do Mercado Bitcoin</title>
      <link>https://gomesfellipe.github.io/post/2025-05-04-bitcoin-agent/</link>
      <pubDate>Sun, 04 May 2025 00:00:00 +0000</pubDate>
      <author>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</author>
      <guid>https://gomesfellipe.github.io/post/2025-05-04-bitcoin-agent/</guid>
      <description>Neste post, exploramos a cria√ß√£o de uma equipe de agentes de IA usando Python, LangChain, LangGraph e LangSmith para automatizar e monitorar a an√°lise do mercado de Bitcoin, desde a coleta de dados at√© a gera√ß√£o de relat√≥rios automatizados.</description>
      <content:encoded>&lt;![CDATA[
        


<!-- Neste post, vamos mergulhar na cria√ß√£o de uma equipe de agentes de Intelig√™ncia Artificial (IA) que trabalham juntos para coletar dados, analisar tend√™ncias e decidir se √© hora de alertar sobre oportunidades de investimento no Bitcoin. Utilizaremos Python, o framework LangChain e sua extens√£o LangGraph para orquestrar esses agentes, al√©m de t√©cnicas de Prompt Engineering para garantir que cada "membro" da equipe execute sua fun√ß√£o com precis√£o.  -->
<!-- Voc√™ j√° se perguntou como acompanhar o vol√°til mercado de Bitcoin sem passar horas analisando gr√°ficos e indicadores complexos?  -->
<!-- Prepare-se para descobrir como a IA generativa pode se tornar sua aliada na an√°lise de criptomoedas! -->
<div id="por-que-analisar-o-mercado-bitcoin-com-agentes-de-ia" class="section level2">
<h2>Por que Analisar o Mercado Bitcoin com Agentes de IA?</h2>
<p>O cen√°rio do bitcoin sempre foi meio intrigante. Foi lan√ßado h√° 16 anos mas at√© hoje ningu√©m sabe ao certo quem est√° por tr√°s do projeto ‚Äî o criador, conhecido apenas pelo pseud√¥nimo Satoshi Nakamoto, <strong>nunca revelou sua identidade</strong>. Al√©m disso o bitcoin foi a <a href="https://www.mgcholding.com.br/blog/blockchain-bitcoin-e-ativos-virtuais-entenda-a-relacao/#:~:text=O%20blockchain%2C%20em%20sua%20ess%C3%AAncia,conhecida%20aplica%C3%A7%C3%A3o%20da%20tecnologia%20blockchain.">primeira e ainda √© a mais conhecida aplica√ß√£o da tecnologia <strong>Blockchain</strong></a>, que revolucionou a forma como lidamos com registros digitais e seguran√ßa dos dados. Sua <strong>natureza descentralizada</strong> e sua not√≥ria <strong>volatilidade</strong> o tornam um ativo √∫nico.</p>
<p>Quem n√£o se lembra da hist√≥ria das <a href="https://www.binance.com/pt-BR/square/post/17395016879858">pizzas compradas por 10.000 BTC</a>, que hoje valeriam uma fortuna? Mesmo que varia√ß√µes dessa magnitude sejam improv√°veis, eventos programados como o <a href="https://www.binance.com/pt-BR/events/bitcoin-halving"><strong>Halving</strong></a> ‚Äì que reduz pela metade a emiss√£o de novas moedas a cada quatro anos, simulando a escassez de metais preciosos ‚Äì continuam a impactar significativamente sua oferta e, historicamente, seu pre√ßo.</p>
<p>Mas como saber o momento certo de comprar ou vender? A resposta n√£o √© simples. O pre√ßo do Bitcoin √© influenciado por uma mir√≠ade de fatores: dados <strong>on-chain</strong> (movimenta√ß√µes na pr√≥pria blockchain), o cen√°rio <strong>macroecon√¥mico</strong> global (infla√ß√£o, taxas de juros), o <strong>sentimento do mercado</strong> e a <strong>an√°lise t√©cnica</strong> tradicional (padr√µes gr√°ficos e indicadores). Analisar isoladamente qualquer um desses aspectos oferece uma vis√£o incompleta. A verdadeira compreens√£o exige uma abordagem hol√≠stica, <strong>combinando diferentes perspectivas</strong>.</p>
<p>Foi pensando nisso, e inspirado pelos recentes avan√ßos em modelos de linguagem grandes (<strong>LLMs</strong>) e frameworks de <strong>agentes</strong>, que surgiu a ideia: <strong>E se eu delegar essa tarefa repetitiva e complexa a uma equipe de assistentes de IA?</strong> E se a IA pudesse n√£o apenas coletar e analisar os dados, mas tamb√©m <strong>interpretar o cen√°rio</strong> e <strong>sugerir a√ß√µes</strong> alinhadas a uma estrat√©gia de investimento de longo prazo, como a acumula√ß√£o gradual de Bitcoin?</p>
<p>√â aqui que entram os Agentes de IA. Pense neles como sistemas aut√¥nomos que utilizam um <strong>LLM</strong> (como os modelos GPT da OpenAI) como seu ‚Äúc√©rebro‚Äù ou motor de racioc√≠nio. Eles podem interagir com <strong>ferramentas</strong>, processar informa√ß√µes e <strong>tomar decis√µes</strong> para atingir um <strong>objetivo espec√≠fico</strong>. Em nosso caso, o objetivo ser√° fornecer uma an√°lise de mercado inteligente e automatizada, transformando dados brutos em insights acion√°veis de alto n√≠vel.</p>
</div>
<div id="arquitetura-da-solu√ß√£o-uma-equipe-de-agentes-de-ia-generativa" class="section level2">
<h2>Arquitetura da Solu√ß√£o: Uma Equipe de Agentes de IA Generativa</h2>
<p>Em vez de um √∫nico agente monol√≠tico tentando fazer tudo, o trabalho foi dividido em etapas l√≥gicas, cada uma atribu√≠da a um agente com um papel bem definido. Essa abordagem modular n√£o s√≥ organiza melhor o processo, mas tamb√©m facilita a manuten√ß√£o e a evolu√ß√£o de cada componente:</p>
<ul>
<li><strong>Data Fetcher</strong>: Coleta dados brutos de diversas APIs (cota√ß√µes, on-chain, macro, t√©cnicos).</li>
<li><strong>Data Analyst</strong>: Interpreta os dados brutos e gera um relat√≥rio t√©cnico formatado.</li>
<li><strong>Market Strategist</strong>: Sintetiza a an√°lise t√©cnica, identifica tend√™ncias e gera recomenda√ß√µes t√°ticas.</li>
<li><strong>Client Manager</strong>: Avalia a estrat√©gia sob a √≥tica do objetivo do ‚Äúcliente‚Äù (acumula√ß√£o de longo prazo) e decide se um alerta √© necess√°rio.</li>
</ul>
<p>Esses agentes utilizam <code>tools</code> (fun√ß√µes Python) para acessar APIs como <a href="https://www.blockchain.com/explorer/api">Blockchain.com</a>, <a href="https://pypi.org/project/yfinance/">Yahoo Finance</a>, <a href="https://www.coingecko.com/en/api/documentation">CoinGecko</a>, <a href="https://fred.stlouisfed.org/">FRED</a>, etc. A orquestra√ß√£o √© feita com o <strong><a href="https://github.com/features/actions">GitHub Actions</a></strong> que aciona a execu√ß√£o de todo o fluxo de trabalho todo dia - a cada 4 horas - executando o projeto que foi todo escrito em <strong>Python</strong>, <strong>LangChain</strong> (para os blocos de constru√ß√£o dos agentes), <strong>LangGraph</strong> (para o fluxo de trabalho), usando <strong>GPT-4o-mini</strong> como motor de racioc√≠nio, <strong><a href="https://telegram.me/BotFather">Telegram</a></strong> como um canal para envio de alertas e <strong>LangSmith</strong> para monitoramento e depura√ß√£o de cada passo da execu√ß√£o dos agentes.</p>
<p style="text-align: left; font-style: italic;">
üìå Clique <a href="https://gomesfellipe.github.io/post/2020-03-25-investment-alert/investment-alert/">aqui</a> para ler meu post sobre como criar bots no Telegram.
</p>
<center>
<div style="width: 90%;">
<p><img src="/post/2025-05-04-bitcoin-agent/full_workflow.png" alt="prompt chaining workflow" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Fluxo de trabalho completo
</p>
</center>
</div>
<div id="construindo-o-workflow-com-langgraph" class="section level2">
<h2>Construindo o Workflow com LangGraph</h2>
<p>Para orquestrar a intera√ß√£o entre os agentes de forma robusta, foi utilizado o <strong>LangGraph</strong>, uma biblioteca sobre o LangChain para criar aplica√ß√µes LLM <em>stateful</em> e com <em>m√∫ltiplos atores</em>. Ele permite definir fluxos de trabalho como grafos, controlando explicitamente a sequ√™ncia e permitindo futuras ramifica√ß√µes ou ciclos.</p>
<div class="w3-panel w3-pale-blue w3-border">
<p>¬† üìå Os conceitos b√°sicos s√£o:</p>
<ul>
<li><strong>N√≥s (Nodes)</strong>: As unidades de trabalho (nossos agentes).</li>
<li><strong>Arestas (Edges)</strong>: As conex√µes que definem o fluxo de dados e controle entre os n√≥s.</li>
</ul>
</div>
<p>Montar o grafo envolve definir o estado compartilhado, adicionar os n√≥s e conectar as arestas. LangGraph oferece diferentes maneiras de definir essa estrutura. Abaixo, tem um exemplo conceitual usando tanto a a <strong>GraphAPI</strong>, que √© bastante expl√≠cita, quanto a <strong>Functional API</strong>, que √© mais direta ao ponto:</p>
<!-- Tabs HTML Structure -->
<div class="tabs">
<p><button class="tablink" onclick="openCode(event, 'GraphAPI')" id="defaultOpen">Graph API (Conceitual)</button>
<button class="tablink" onclick="openCode(event, 'FunctionalAPI')">Functional API (Conceitual)</button></p>
</div>
<div id="GraphAPI" class="tabcontent">
<pre class="python"><code>from langgraph.graph import StateGraph, START, END
from typing_extensions import TypedDict

# Definir o Estado do Grafo
class State(TypedDict):
    topic: str # Input do Data Fetcher
    raw_data: str # Sa√≠da do Data Fetcher
    analysis_report: str # Sa√≠da do Data Analyst
    strategy_synthesis: str # Sa√≠da do Market Strategist
    manager_decision: str # Sa√≠da do Client Manager

# Definir os N√≥s (Agentes/Fun√ß√µes)
# Supondo que as fun√ß√µes j√° foram definidas
def data_fetcher(state: State):
    # ... 
    return {&quot;raw_data&quot;: &quot;dados coletados...&quot;}

def data_analyst(state: State): ...
def market_strategist(state: State): ...
def client_manager(state: State): ...
def send_telegram_message(message_body): ...

# Construir o Grafo
workflow = StateGraph(State)

# Adicionar os n√≥s
workflow.add_node(&quot;fetcher&quot;, data_fetcher)
workflow.add_node(&quot;analyst&quot;, data_analyst)
workflow.add_node(&quot;strategist&quot;, market_strategist)
workflow.add_node(&quot;manager&quot;, client_manager)

# Definir Arestas (o fluxo sequencial)
workflow.add_edge(START, &quot;fetcher&quot;)
workflow.add_edge(&quot;fetcher&quot;, &quot;analyst&quot;)
workflow.add_edge(&quot;analyst&quot;, &quot;strategist&quot;)
workflow.add_conditional_edges(&quot;strategist&quot;, manager_decision, {
  &quot;ALERTAR_CLIENTE&quot;: &quot;send_telegram_message&quot;,
  &quot;NAO_ALERTAR&quot;: END
  })

# Compilar o grafo em um objeto execut√°vel
chain = workflow.compile()

# Executar (exemplo)
state = chain.invoke({&quot;topic&quot;: &quot;btc&quot;})</code></pre>
</div>
<div id="FunctionalAPI" class="tabcontent">
<pre class="python"><code>from langgraph.func import entrypoint, task

# Tasks/Agents

@task
def data_fetcher(topic: str) -&gt; dict: ...
  
@task 
def data_analyst(state: State): ...

@task
def market_strategist(state: State): ...

@task
def client_manager(state: State): ...

def plot_btc_analysis(): ...
def send_telegram_photo(fig): ...
def send_telegram_message(message_body): ...

# Exemplo conceitual com abordagem funcional (usando decoradores)
@entrypoint()
def chaining_workflow(topic: str):
    data_fetched = data_fetcher(topic).result()
    analyst_report = data_analyst(data_fetched).result()
    strategist_report = market_strategist(analyst_report).result()
    
    if &#39;ALERTAR&#39; in client_manager(strategist_report).result():
        fig = plot_btc_analysis()
        asyncio.run(send_telegram_photo(fig))
        asyncio.run(send_telegram_message(strategist_report))
        return &quot;Entrar em contato&quot;
    return &quot;N√£o entrar em contato&quot;

def run_chaining_workflow(topic: str, stream_mode: str = &quot;updates&quot;):
    return chaining_workflow.stream(topic, stream_mode=stream_mode)

# Invoke
logger.info(&quot;Iniciando o workflow...\n&quot;)
for step in run_chaining_workflow(&quot;&quot;, stream_mode=&quot;updates&quot;):
    for key, value in step.items():
        logger.info(f&quot;[ {key} ]\n{&#39;=&#39; * 80}\n{value}\n&quot;)
logger.info(&quot;Workflow finalizado.&quot;)
        </code></pre>
</div>
<!-- Script para funcionalidade das abas -->
<script>
function openCode(evt, codeName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(codeName).style.display = "block";
  evt.currentTarget.className += " active";
}
// Abre a primeira aba por padr√£o
document.getElementById("defaultOpen").click();
</script>
<!-- Estilos b√°sicos para as abas (adicione ao CSS do seu blog) -->
<style>
.tabs { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
.tablink { background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 8px 16px; font-size: 1rem; transition: 0.3s; }
.tablink:hover { background-color: #ddd; }
.tablink.active { background-color: #ccc; }
.tabcontent { display: none; padding: 6px 0px; border-top: none; animation: fadeEffect 1s; }
@keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
</style>
<p>Este controle fino do fluxo, seja pela API expl√≠cita ou por abordagens mais funcionais, √© uma das grandes vantagens do LangGraph para sistemas multi-agentes, que ainda permite uma integra√ß√£o com o LangSmith para acompanhamento detalhado do fluxo de ‚Äúracioc√≠nio‚Äù dos agentes. Para mais detalhes, consulte a <a href="https://langchain-ai.github.io/langgraph/">documenta√ß√£o oficial</a>.</p>
</div>
<div id="mergulhando-nos-agentes-prompts-e-ferramentas" class="section level2">
<h2>Mergulhando nos Agentes: Prompts e Ferramentas</h2>
<p>Vamos ver rapidamente como cada agente funciona, focando nos prompts e ferramentas:</p>
<div id="agente-1-data-fetcher-o-pesquisador" class="section level3">
<h3>Agente 1: Data Fetcher (O Pesquisador)</h3>
<center>
<div style="width: 90%;">
<p><img src="/post/2025-05-04-bitcoin-agent/01.png" alt="data fetcher agent" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Fluxo de trabalho do Data Researcher
</p>
</center>
<details>
<summary>
<em>Ver c√≥digo</em>
</summary>
<pre class="python"><code>from pydantic import BaseModel, Field
from langchain.schema.messages import HumanMessage, ToolMessage
from langgraph.func import task
from langchain_openai import ChatOpenAI

from tools.fetch_data_btc import fetch_data_btc
from tools.fetch_data_onchain import fetch_data_onchain
from tools.fetch_data_macroeconomic import fetch_data_macroeconomic
from tools.fetch_data_market import fetch_data_market
from tools.fetch_data_tecnical import fetch_data_tecnical

llm = ChatOpenAI(model=&quot;gpt-4o-mini&quot;, temperature=0)

@task
def data_fetcher(topic: str):
  
  class StructuredJsonOutput(BaseModel):
    btc_data: str = Field(None, description=&quot;Bitcoin data and USD to BRL exchange rate&quot;)
    onchain_data: str = Field(None, description=&quot;On-chain Bitcoin data&quot;)
    macroeconomic_data: str = Field(None, description=&quot;Macroeconomic data&quot;)
    market_data: str = Field(None, description=&quot;Market sentiment and Bitcoin-related metrics&quot;)
    tecnical_data: str = Field(None, description=&quot;technical analysis indicators for Bitcoin&quot;)

  structured_llm = llm.with_structured_output(StructuredJsonOutput)

  instructions = &quot;Voc√™ √© um pesquisador respons√°vel por coletar dados de diferentes fontes sobre o mercado de Bitcoin e gerar um output no formato json.&quot;

  tools = [
      fetch_data_btc,
      fetch_data_onchain,
      fetch_data_macroeconomic,
      fetch_data_market,
      fetch_data_tecnical
      ]

  tools_by_name = {tool.name: tool for tool in tools}

  llm_with_tools = llm.bind_tools(tools)

  messages = [HumanMessage(instructions)]
  ai_msg = llm_with_tools.invoke(messages)
  messages.append(ai_msg)

  for tool_call in ai_msg.tool_calls:
      selected_tool = tools_by_name[tool_call[&quot;name&quot;].lower()]
      tool_output = selected_tool.invoke(tool_call[&quot;args&quot;])
      messages.append(ToolMessage(tool_output, tool_call_id=tool_call[&quot;id&quot;]))

  messages.append(structured_llm.invoke(messages))

  return messages[-1].model_dump_json(indent=3)</code></pre>
</details>
<ul>
<li><strong>Objetivo</strong>: Coletar dados brutos e atualizados de diversas fontes sobre o Bitcoin, abrangendo cota√ß√µes, indicadores on-chain, dados macroecon√¥micos e t√©cnicos.</li>
<li><strong>Funcionamento</strong>: Este agente n√£o calcula nem interpreta, ele apenas orquestra a chamada de v√°rias <code>tools</code> (fun√ß√µes Python que interagem com APIs externas). Essa fun√ß√£o do LangChain permite que o LLM, ao receber a instru√ß√£o inicial (‚Äúcolete os dados sobre o mercado de Bitcoin‚Äù), analise as ferramentas dispon√≠veis e decida quais delas chamar e com quais argumentos. Ap√≥s as ferramentas retornarem seus resultados, usamos <code>llm.with_structured_output(StructuredJsonOutput)</code> para instruir o LLM a consolidar todas as informa√ß√µes coletadas em um √∫nico objeto <strong>JSON estruturado</strong>. Isso garante que a sa√≠da do Data Fetcher seja consistente e f√°cil de processar pelo pr√≥ximo agente.</li>
</ul>
</div>
<div id="agente-2-data-analyst-o-int√©rprete" class="section level3">
<h3>Agente 2: Data Analyst (O Int√©rprete)</h3>
<center>
<div style="width: 90%;">
<p><img src="/post/2025-05-04-bitcoin-agent/02.png" alt="data analyst agent" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Fluxo de trabalho do Data Analyst
</p>
</center>
<details>
<summary>
<em>Ver c√≥digo</em>
</summary>
<pre class="python"><code>from langgraph.func import task
from langchain.prompts import ChatPromptTemplate, FewShotChatMessagePromptTemplate
from langchain_openai import ChatOpenAI

from prompts.data_analyst_example import input_example, output_example

llm = ChatOpenAI(model=&quot;gpt-4&quot;, temperature=0.7)

@task
def data_analyst(report: str):

  input = f&quot;&quot;&quot;
  Voc√™ √© um analista financeiro experiente em Cryptomoedas e especialista em Bitcoin.
  Analise as tend√™ncias do cen√°rio do Bitcoin hoje com base no json \
  delimitado por tr√™s crases (```):

  \```
  {report}
  \```

  Siga rigorosamente as instru√ß√µes abaixo:

  - ...
  &quot;&quot;&quot;

  examples = [
      {&quot;input&quot;: input_example, &quot;output&quot;: output_example},
       ]

  example_prompt = ChatPromptTemplate.from_messages([
      (&quot;human&quot;, &quot;{input}&quot;),
      (&quot;ai&quot;, &quot;{output}&quot;),
      ])

  few_shot_prompt = FewShotChatMessagePromptTemplate(
      example_prompt=example_prompt,
      examples=examples,
      )

  prompt_system = &quot;Voc√™ √© um analista financeiro experiente em Criptomoedas e especialista em Bitcoin.&quot;

  final_prompt = ChatPromptTemplate.from_messages([
    (&quot;system&quot;, prompt_system),
    few_shot_prompt,
    (&quot;human&quot;, &quot;{input}&quot;),
    ])

  chain = final_prompt | llm

  msg = chain.invoke(input=input)

  return msg.content</code></pre>
</details>
<ul>
<li><strong>Objetivo</strong>: Receber o JSON de dados brutos do Data Fetcher e transform√°-lo em um relat√≥rio anal√≠tico coeso, formatado em Markdown, interpretando cada indicador e explicando seu poss√≠vel impacto.</li>
<li><strong>Prompt Engineering em A√ß√£o</strong>: Este agente √© um √≥timo exemplo de como guiar um LLM para tarefas complexas de formata√ß√£o e interpreta√ß√£o.
<ul>
<li><strong>Instru√ß√µes Detalhadas</strong>: O prompt define explicitamente o papel do agente (‚Äúanalista financeiro experiente‚Äù), o formato desejado (Markdown, bullet points, negrito), o tom (‚Äúequilibrado e menos t√©cnico‚Äù), e regras espec√≠ficas (mencionar pre√ßos em USD e BRL, usar sinal de menos para varia√ß√µes negativas, seguir a estrutura do exemplo).</li>
<li><strong>Estrat√©gia Few-Shot</strong>: Para garantir que o LLM siga o formato e o estilo de interpreta√ß√£o desejados, utilizamos a t√©cnica Few-Shot (semelhante como fiz em um <a href="https://gomesfellipe.github.io/post/2024-05-26-detec-o-de-linguagem-t-xica-com-o-llm-gemma-e-langchain/">post anterior</a>). Fornecemos um exemplo completo de um input (um JSON de dados similar ao que o Data Fetcher produziria) e o output correspondente (o relat√≥rio em Markdown formatado e interpretado). Isso √© feito usando <code>FewShotChatMessagePromptTemplate</code> do LangChain, que insere o exemplo diretamente no contexto do prompt final.</li>
<li><strong>Cadeia LCEL</strong>: O prompt final √© constru√≠do usando a LangChain Expression Language (LCEL), combinando o prompt do sistema (definindo o papel), o prompt Few-Shot (com o exemplo) e o prompt humano (contendo as instru√ß√µes e o JSON de dados brutos atual).</li>
</ul></li>
</ul>
</div>
<div id="agente-3-market-strategist-o-conselheiro" class="section level3">
<h3>Agente 3: Market Strategist (O Conselheiro)</h3>
<center>
<div style="width: 80%;">
<p><img src="/post/2025-05-04-bitcoin-agent/03.png" alt="market strategist agent" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Fluxo de trabalho do Market Strategist
</p>
</center>
<details>
<summary>
<em>Ver c√≥digo</em>
</summary>
<pre class="python"><code>from langgraph.func import task
from langchain.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(temperature=0.7)

@task
def market_strategist(analyst_report: str):
    &quot;&quot;&quot;
    Gera recomenda√ß√µes de posicionamento com base na an√°lise do Data Analyst.
    &quot;&quot;&quot;
  
    input = f&quot;&quot;&quot;
    Seu papel √© analisar o relat√≥rio t√©cnico fornecido no formatado em Markdown e transformar\
    em uma s√≠ntese estrat√©gica e executiva, com alertas, insights e orienta√ß√µes t√°ticas de alto n√≠vel.
  
    \``` markdown
    {analyst_report}
    \```
  
    Siga rigorosamente as instru√ß√µes abaixo:
  
    - ...
    &quot;&quot;&quot;
  
    prompt = ChatPromptTemplate.from_messages([
        (&quot;system&quot;, &quot;Voc√™ √© um estrategista de mercado s√™nior, com ampla experi√™ncia em ativos digitais e especializa√ß√£o em Bitcoin.&quot;),
        (&quot;human&quot;, &quot;{input}&quot;)
    ])
  
    chain = prompt | llm
    msg = chain.invoke(input=input)
    return msg.content
</code></pre>
</details>
<ul>
<li><strong>Objetivo</strong>: Ler o relat√≥rio t√©cnico detalhado do Data Analyst e interpretar as informa√ß√µes em uma s√≠ntese estrat√©gica e executiva. O foco √© identificar a tend√™ncia geral, destacar sinais chave e fornecer recomenda√ß√µes t√°ticas claras.</li>
<li><strong>Prompt</strong>: O prompt para este agente √© crucial para mudar o n√≠vel da an√°lise. Ele instrui o LLM a agir como um ‚Äúestrategista de mercado s√™nior‚Äù, focando em:
<ul>
<li><strong>Resumo</strong>: Extrair os pontos mais cr√≠ticos.</li>
<li><strong>Tend√™ncia</strong>: Classificar o mercado (alta, baixa, neutro).</li>
<li><strong>Sinais</strong>: Identificar indicadores de otimismo ou cautela.</li>
<li><strong>Recomenda√ß√µes</strong>: Gerar orienta√ß√µes pr√°ticas e acion√°veis (‚Äúisso indica que‚Ä¶‚Äù, ‚Äúlogo, √© prudente‚Ä¶‚Äù).</li>
<li><strong>Racioc√≠nio</strong>: Explicitar o processo de pensamento com <strong>CoT</strong> (<strong>Chain-of-Thought</strong>) que levou √†s conclus√µes antes de apresentar a s√≠ntese final.</li>
<li><strong>Tom</strong>: Consultivo, direto e profissional.</li>
</ul></li>
</ul>
</div>
<div id="agente-4-client-manager-o-porteiro" class="section level3">
<h3>Agente 4: Client Manager (O Porteiro)</h3>
<center>
<div style="width: 80%;">
<p><img src="/post/2025-05-04-bitcoin-agent/04.png" alt="client manager agent" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Fluxo de trabalho do Client Manager
</p>
</center>
<details>
<summary>
<em>Ver c√≥digo</em>
</summary>
<pre class="python"><code>from langgraph.func import task
from langchain.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(temperature=0.7)

@task
def client_manager(final_report: str):
    &quot;&quot;&quot;
    Avalia o relat√≥rio estrat√©gico e decide se deve ou n√£o alertar o cliente.
    A decis√£o final √© bin√°ria: ALERTAR_CLIENTE ou N√ÉO_ALERTAR.
    &quot;&quot;&quot;

    input = f&quot;&quot;&quot;
    Objetivo do cliente: Acumular Bitcoins no longo prazo, investindo mensalmente nas melhores janelas de oportunidade.

    Seu papel √© avaliar o relat√≥rio abaixo e decidir se h√° motivos suficientes para alertar o cliente:

    \``` markdown
    {final_report}
    \```

    Siga rigorosamente as instru√ß√µes abaixo:

    - ...
    &quot;&quot;&quot;

    prompt = ChatPromptTemplate.from_messages([
        (&quot;system&quot;, &quot;Voc√™ √© um Client Manager, especializado em comunica√ß√£o estrat√©gica com clientes de alto valor.&quot;),
        (&quot;human&quot;, &quot;{input}&quot;)
    ])

    chain = prompt | llm
    msg = chain.invoke(input=input)
    return msg.content
</code></pre>
</details>
<ul>
<li><strong>Objetivo</strong>: Avaliar a s√≠ntese estrat√©gica do Market Strategist √† luz do objetivo espec√≠fico do cliente (acumula√ß√£o de longo prazo) e tomar uma decis√£o bin√°ria: a situa√ß√£o atual justifica um alerta ou n√£o?</li>
<li><strong>Prompt</strong>: Este prompt √© focado na tomada de decis√£o.
<ul>
<li><strong>Contexto do Cliente</strong>: Define claramente o objetivo (‚ÄúAcumular Bitcoins no longo prazo, investindo mensalmente nas melhores janelas de oportunidade.‚Äù).</li>
<li><strong>Crit√©rios de Alerta</strong>: Especifica o que procurar (mudan√ßa relevante de tend√™ncia, risco/oportunidade claros, indicadores extremos, recomenda√ß√µes urgentes).</li>
<li><strong>Racioc√≠nio Obrigat√≥rio</strong>: Exige que o agente explique seu processo de pensamento <strong>CoT</strong> (<strong>Chain-of-Thought</strong>) antes da decis√£o final.</li>
<li><strong>Output Bin√°rio</strong>: A resposta final deve ser <em>apenas</em> a palavra <code>ALERTAR</code> ou <code>N√ÉO_ALERTAR</code> em mai√∫sculas, precedida pelo racioc√≠nio.</li>
</ul></li>
</ul>
</div>
</div>
<div id="desafios-aprendizados-e-observabilidade" class="section level2">
<h2>Desafios, Aprendizados e Observabilidade</h2>
<p>Construir agentes envolve desafios:</p>
<ul>
<li><strong>Prompt Engineering</strong>: √â uma arte iterativa. Clareza, exemplos (Few-Shot) e estrutura s√£o essenciais.</li>
<li><strong>Orquestra√ß√£o (LangGraph)</strong>: Gerenciar o estado e o fluxo entre n√≥s exige aten√ß√£o.</li>
<li><strong>Integra√ß√£o de Ferramentas</strong>: Descri√ß√µes claras das <code>tools</code> s√£o vitais para o LLM us√°-las corretamente.</li>
<li><strong>Observabilidade</strong>: Identificar falhas em fluxos complexos pode ser dif√≠cil.</li>
</ul>
<p>Ferramentas como o <strong>LangSmith</strong> s√£o extremamente √∫teis na monitoramento dos agentes, permitindo rastrear e depurar cada passo de sua execu√ß√£o, chamadas de LLM e uso de ferramentas. Ele oferece uma vis√£o clara do que est√° acontecendo ‚Äúpor baixo dos panos‚Äù, facilitando a identifica√ß√£o de gargalos ou erros.</p>
<center>
<div style="width: 90%;">
<p><img src="/post/2025-05-04-bitcoin-agent/langsmith-exemplo.png" alt="langsmith" style="width: 100%;"></p>
</div>
<p style="text-align: center; font-style: italic;">
Print da tela do LangSmith do projeto
</p>
</center>
</div>
<div id="conclus√£o" class="section level2">
<h2>Conclus√£o</h2>
<p>Criamos uma equipe de agentes IA capaz de automatizar a complexa an√°lise do mercado Bitcoin, usando LangChain e LangGraph para orquestra√ß√£o. O sistema coleta dados, interpreta, gera estrat√©gias e decide sobre alertas, transformando dados brutos em insights acion√°veis. Veja como √© o alerta recebido no Telegram:</p>
<div style="display: flex; justify-content: space-between; align-items: center;">
<center>
<p><img src="/post/2025-05-04-bitcoin-agent/telegram1.PNG" alt="Report no Telegram 1" style="width: 80%;"></p>
</center>
<center>
<p><img src="/post/2025-05-04-bitcoin-agent/telegram2.PNG" alt="Report no Telegram 2" style="width: 80%;"></p>
</center>
</div>
<p style="text-align: center; font-style: italic;">
Print das telas do bot no Telegram.
</p>
<p>Este projeto demonstra o potencial dos agentes para automatizar tarefas repetitivas que envolvem a tomada de decis√µes com um certo ‚Äúracioc√≠nio‚Äù. Os pr√≥ximos passos podem envolver refinar prompts, adicionar mais ferramentas, integrar mais visualiza√ß√µes ou implementar notifica√ß√µes ativas.</p>
</div>
<div id="refer√™ncias" class="section level2">
<h2>Refer√™ncias</h2>
<ul>
<li><a href="https://python.langchain.com/">LangChain - Documenta√ß√£o</a></li>
<li><a href="https://langchain-ai.github.io/langgraph/">LangGraph - Documenta√ß√£o</a></li>
<li><a href="https://smith.langchain.com/">LangSmith - Documenta√ß√£o</a></li>
<li><a href="https://openai.com/api/">OpenAI API Plataform</a></li>
<li><a href="https://github.com/openai/openai-cookbook/blob/main/examples/gpt4-1_prompting_guide.ipynb">OpenAI - Prompt Engineering Guide</a></li>
<li><a href="https://cdn.openai.com/business-guides-and-resources/a-practical-guide-to-building-agents.pdf">OpenAI - A Practical Guide to Building Agents</a></li>
<li><a href="https://langchain-ai.github.io/langgraph/tutorials/workflows/">LangGraph Tutorial - Building Agentic Workflows</a></li>
<li><a href="https://blog.langchain.dev/how-to-think-about-agent-frameworks/">LangChain Blog - How to think about agent frameworks</a></li>
</ul>
</div>

        <p><strong>Leia o post completo em:</strong> <a href="https://gomesfellipe.github.io/post/2025-05-04-bitcoin-agent/">Construindo uma Equipe Multiagente de IA para An√°lise do Mercado Bitcoin</a></p>
        <p><em>Este post foi originalmente publicado em <a href="https://gomesfellipe.github.io/">Fellipe Gomes - Data Science Blog</a></em></p>
      ]]></content:encoded>
      <category>Fundamentos de Data Science</category>
      <category>Intelig√™ncia Artificial</category>
      <category>Programa√ß√£o e Ferramentas</category>
      <category domain="tag">agent-ai</category>
      <category domain="tag">analise-dados</category>
      <category domain="tag">bitcoin</category>
      <category domain="tag">crypto</category>
      <category domain="tag">inteligencia-artificial</category>
      <category domain="tag">langchain</category>
      <category domain="tag">langgraph</category>
      <category domain="tag">langsmith</category>
      <category domain="tag">llm</category>
      <category domain="tag">mercado-financeiro</category>
    </item>
    <item>
      <title>Desenvolva um bot e receba resultados de Machine Learning no seu Smartphone para ajudar nos investimentos</title>
      <link>https://gomesfellipe.github.io/post/2020-03-25-investment-alert/investment-alert/</link>
      <pubDate>Wed, 25 Mar 2020 00:00:00 +0000</pubDate>
      <author>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</author>
      <guid>https://gomesfellipe.github.io/post/2020-03-25-investment-alert/investment-alert/</guid>
      <description>Entenda a l√≥gica de como montar uma carteira, coletar dados de finan√ßa em tempo real, treinar um modelo de Machine Learning com Prophet (Facebook Open Source) e receber an√°lises automatizadas no Smartphone</description>
      <content:encoded>&lt;![CDATA[
        


<style>
.column {
  float: left;
  width: 50%;
  padding: 10px;
}

.column4 {
  float: left;
  width: 33%;
  padding: 10px;
}

.column8 {
  float: left;
  width: 66%;
  padding: 10px;
}

.row:after {
  content: "";
  display: table; 
  clear: both;
}
</style>
<div id="por-que-investir" class="section level1">
<h1>Por que investir?</h1>
<p>Como esta sua situa√ß√£o financeira? Caso tenha alguma reserva pode ser interessante pensar em investimentos pois a poupan√ßa j√° n√£o √© mais garantia de lucro no longo prazo, n√£o acredita?</p>
<p>Estamos no final do primeiro trimestre de 2020 e desde 2019 j√° liam-se not√≠cias como esta abaixo que levam √† reflex√£o sobre reeduca√ß√£o financeira pois alertam sobre a necessidade da busca por novas oportunidades de investimento.</p>
<center>
<img src="/post/2020-03-25-investment-alert/noticia_poupanca.png" style="width:50.0%" /> <br><small>Fonte: <a href="https://noticias.r7.com/economia/economize/poupanca-em-baixa-exige-busca-por-novos-investimentos-em-2020-25122019" class="uri">https://noticias.r7.com/economia/economize/poupanca-em-baixa-exige-busca-por-novos-investimentos-em-2020-25122019</a></small>
</center>
<p></br></p>
<p>Com a finalidade de fomentar um pouco a discuss√£o sobre investimentos, trouxe nesse post algumas sugest√µes e id√©ias de como elaborar uma carteira e otimizar as escolhas para equilibrar risco em novos investimentos combinando elementos de estat√≠stica, machine learning e programa√ß√£o em R.</p>
<p>Ao final do post criaremos um <a href="https://core.telegram.org/bots">rob√¥ no telegram</a> que coletar√° os dados das cota√ß√µes adquiridas, aplicar√° o modelo <a href="https://facebook.github.io/prophet/docs/quick_start.html">Prophet do Facebook</a> para forecast e analisar√° a desmontagem da carteira segundo os crit√©rios estabelecidos e enviar√° mensagens para n√≥s com uma tabela financeira automatizada via Telegram como mostra na anima√ß√£o:</p>
<p></br></p>
<div class="row">
<div class="column4">
<center>
<img src="/post/2020-03-25-investment-alert/watch.png" />
</center>
</div>
<div class="column8">
<p><img src="/post/2020-03-25-investment-alert/report_stocks.gif" style="width:90.0%" /></p>
</div>
</div>
<p></br></p>
<div class="w3-panel w3-pale-red w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>AVISO</strong>: Este post <strong>n√£o</strong> tem como finalidade ser um guia de investimentos (J√° existem muitas consultorias especializadas nisso por ai). Todos as decis√µes tomadas como diversifica√ß√£o da carteira, sele√ß√£o de a√ß√µes e crit√©rios para desmontagem da carteira s√£o <strong>exemplos</strong> e servem para ilustrar algumas <strong>possibilidades</strong> que um cientista de dados t√™m na hora de desenvolver ferramentas para auxiliar √† tomada de decis√£o.</p>
</div>
<p></br></p>
<div id="diferen√ßa-de-poupar-e-investir" class="section level2">
<h2>Diferen√ßa de poupar e investir</h2>
<p>De acordo com um <a href="https://www.infomoney.com.br/minhas-financas/brasileiros-nao-sabem-a-diferenca-entre-poupar-e-investir-afirma-especialista-2/">especialista entrevistado pela InfoMoney</a>:</p>
<blockquote>
‚ÄúPoupar √© guardar dinheiro para usar no futuro, comprar alguma coisa com ele. Investimento √© juntar dinheiro, n√£o mexer nele, para que este gere rendimentos e a√≠ sim, usar os lucros mais para frente. √â o recomendado para quem quer viver de renda no futuro, por exemplo‚Äù (‚Ä¶)
<div align="right">
<font size="1">InfoMoney - Ago 2015</font>
</div>
</blockquote>
<p>Ou seja, poupar √© acumular agora para utilizar depois, e normalmente envolve mudan√ßa de h√°bitos, pois requer uma redu√ß√£o nos gastos pessoais e familiares, j√° investir √© usar esse dinheiro poupado em aplica√ß√µes que rendam.</p>
<p>Como todo mundo sabe, n√£o existe investimento sem risco e este risco deve ser controlado e utilizado a nosso favor de forma que gere alguma seguran√ßa financeira.</p>
</div>
</div>
<div id="montagem-da-carteira" class="section level1">
<h1>Montagem da carteira</h1>
<div class="row">
<div class="column8">
<p>N√£o colocar todos os ovos na mesma cesta significa que voc√™ deve diversificar o seu investimento. Provavelmente voc√™ j√° ouviu essa frase alguma vez na vida e ela certamente faz sentido!</p>
<p>Diversificar a carteira ir√° proteger seus investimentos diminuindo o risco pois, imagine s√≥, voc√™ investe todo o seu dinheiro em uma empresa e ela passa por alguma crise assim seu dinheiro estar√° todo comprometido!</p>
<p>Existem diversos motivos para se diversificar a carteira mas acho que essa met√°fora dos ovos j√° resume bem pois acredito que ningu√©m queira perder tudo em uma queda.</p>
</div>
<div class="column4">
<p><img src="/post/2020-03-25-investment-alert/ovos_mesm_cesta.png" style="width:90.0%" /></p>
</div>
</div>
<div id="como-dividir-a-carteira" class="section level2">
<h2>Como dividir a carteira?</h2>
<p>Dependendo do risco que voc√™ deseja se expor existem muitas formas de preparar a carteira mas a id√©ias principal consiste em atingir um equil√≠brio entre dois tipos de investimento:</p>
<ul>
<li>Renda fixa: Menor exposi√ß√£o, menor risco (ex.: CDI, Selic e TR)</li>
<li>Renda vari√°vel: Maior exposi√ß√£o, maior risco (ex: A√ß√µes, Commodities, Im√≥veis)</li>
</ul>
<p>Para ajudar a dividir a carteira de investimentos neste post utilizaremos a chamada <a href="https://www.btgpactualdigital.com/blog/coluna-gustavo-cerbasi/defina-sua-estrategia-entre-renda-fixa-ou-variavel">Regra (ou Lei) dos 80</a>. A estrat√©gia √© a seguinte: subtraia da sua idade o n√∫mero 80. O resultado dessa conta vai indicar o percentual a ser investido em <a href="https://pt.wikipedia.org/wiki/Renda_vari%C3%A1vel">renda vari√°vel</a>. Por exemplo, no meu caso: tenho 26 anos, portanto <span class="math inline">\(80-26 = 54\%\)</span> dever√° ser investido em renda vari√°vel. Aos 53 anos esse percentual vai cair√° para a metade, <span class="math inline">\(27\%\)</span>.</p>
<p>A id√©ias principal por tr√°s desta regra que √© que a cada ano que passa, 1% do montante da renda vari√°vel deva ser direcionado para a <a href="https://pt.wikipedia.org/wiki/Renda_fixa">renda fixa</a>.</p>
<p>Para testar diferentes valores seguindo esta regra desenvolvi uma fun√ß√£o que se chama <a href="https://gist.github.com/gomesfellipe/a74710a63b3c8637166b538ad2f460f5"><code>montagem80()</code> (que j√° est√° dispon√≠vel no github)</a>. Vejamos alguns resultados para diferentes cen√°rios e vamos selecionar um para seguir com a montagem da carteira:</p>
<pre class="r"><code># https://gist.github.com/gomesfellipe/a74710a63b3c8637166b538ad2f460f5
devtools::source_gist(&quot;a74710a63b3c8637166b538ad2f460f5&quot;, quiet = T)</code></pre>
<div class="row">
<div class="column">
<ol style="list-style-type: decimal">
<li>Entrada de R$20.000,00 <big>üëà</big></li>
</ol>
<pre class="r"><code>montagem80(entrada = 20000, idade = 26)</code></pre>
<pre><code>## ‚Ä¢ Entrada: R$R$20.000,00
##   ‚îî‚îÄ Renda fixa:     R$9.200,00
##   ‚îî‚îÄ Renda variavel: R$10.800,00
##        (Acao + Cryptomoeda): 
##        R$9.720,00 + R$1.080,00</code></pre>
</div>
<div class="column">
<ol start="2" style="list-style-type: decimal">
<li>R$ 5.000,00 em acoes</li>
</ol>
<pre class="r"><code>montagem80(variavel = 10800, idade = 53)</code></pre>
<pre><code>## ‚Ä¢ Entrada: R$R$40.000,00
##   ‚îî‚îÄ Renda fixa:     R$29.200,00
##   ‚îî‚îÄ Renda variavel: R$10.800,00
##        (Acao + Cryptomoeda): 
##        R$9.720,00 + R$1.080,00</code></pre>
</div>
</div>
<p>Utilizaremos a primeira (1.) configura√ß√£o que esta assinalada em vermelho como exemplo, onde:</p>
<ul>
<li>Entrada: R$20.000,00</li>
<li>Renda fixa: R$9.200,00</li>
<li>Renda Vari√°vel (Acoes): R$9.720,00</li>
<li>Renda Vari√°vel (Crypt): R$1.080,00</li>
</ul>
<p>Note que a entrada deve ser o dobro na segunda (2.) configura√ß√£o caso deseje investir R$10.800,00 (que √© o valor sugerido aos 26 anos para uma entrada de R$20.000,00)</p>
<p>Ap√≥s definir a quantidade a ser investida √© hora de planejar a pr√≥xima etapa: a diversifica√ß√£o.</p>
</div>
<div id="diversifica√ß√£o-da-carteira" class="section level2">
<h2>Diversifica√ß√£o da carteira</h2>
<div class="row">
<div class="column8">
<p>A diversifica√ß√£o √© uma t√©cnica para gest√£o do risco que visa distribuir o capital investido em uma variedade de investimentos dentro de da nossa carteira.</p>
<p>Assim, o risco do portf√≥lio √© consideravelmente reduzido pois reduzimos a volatividade e criamos um equil√≠brio onde um desempenho positivo de um ativo neutraliza as baixas ocorridas em outras aplica√ß√µes. Al√©m disso a diversifica√ß√£o pode ser tanto coma renda vari√°vel quanto com a renda fixa.</p>
<p>Mas lembre-se, n√£o existe uma receita mais eficiente!</p>
</div>
<div class="column4">
</br>
<iframe src="https://giphy.com/embed/qJkRbWM1MfVjq" width="100%" height="150" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
<p>
<a href="https://giphy.com/gifs/eggs-qJkRbWM1MfVjq">via GIPHY</a>
</p>
</div>
</div>
<div id="renda-fixa" class="section level3">
<h3>Renda fixa</h3>
<p>Normalmente, tamb√©m diversificamos nossa renda fixa por√©m como gostaria de focar nas an√°lises de renda vari√°vel utilizaremos o simulador dispon√≠vel no site <a href="https://verios.com.br/" class="uri">https://verios.com.br/</a> neste <a href="https://simulador-tesouro-direto.verios.com.br/">link</a> para selecionar apenas um t√≠tulo:</p>
<center>
<img src="/post/2020-03-25-investment-alert/tesouro_direto.png" style="width:80.0%" />
<small></br>Fonte: <a href="https://simulador-tesouro-direto.verios.com.br/" class="uri">https://simulador-tesouro-direto.verios.com.br/</a></small>
</center>
<p></br></p>
<p>Como exemplo, escolhi o Tesouro Prefixado 2015 (LTN), note que com essa escolha o lucro planejado seria de quase 3 mil reais nos pr√≥ximos 5 anos.</p>
<div class="w3-panel w3-pale-red w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>AVISO</strong>: Lembrando que esta sele√ß√£o √© apenas um exemplo e existem diversas informa√ß√µes a serem levadas em conta ao se fazer esta escolha al√©m de se poder diversificar tamb√©m. Convido o leitor a procurar saber mais sobre os tipos, pr√≥s e contras do Tesouro Direto.</p>
</div>
</div>
<div id="renda-vari√°vel" class="section level3">
<h3>Renda vari√°vel</h3>
<p>Para elabora√ß√£o da parte da renda vari√°vel da carteira selecionei duas a√ß√µes que s√£o inversamente correlacionadas (de forma totalmente arbitr√°ria) baseado no excelente post "<a href="https://www.tradingcomdados.com/post/2017/07/09/estudo-de-correla%C3%A7%C3%A3o-entre-a%C3%A7%C3%B5es-da-bolsa-de-valores-de-s%C3%A3o-paulo">Estudo de correla√ß√£o entre a√ß√µes da Bolsa de Valores de S√£o Paulo</a>" escrito por Victor Gomes onde o autor faz um estudo de correla√ß√µes das s√©ries hist√≥ricas de a√ß√µes de diferentes setores.</p>
<p>Al√©m disso, o Bitcoin ser√° selecionado para completar a carteira de renda vari√°vel como um ativo de alto risco com bastante volatividade. Mas voc√™ deve estar se perguntando, por que assumir este risco?</p>
<p>Existem muitas hist√≥rias de pessoas que ficaram milion√°rias com o Bitcoin pela sua valoriza√ß√£o inesperada ao longo do tempo, como por exemplo o <a href="https://www.infomoney.com.br/mercados/adolescente-fica-milionario-aos-18-anos-usando-bitcoins-apos-fazer-aposta-com-os-pais/">adolescente que ficou milion√°rio aos 18 anos usando bitcoins ap√≥s fazer aposta com os pais</a>.</p>
<p>Ent√£o <strong>eu</strong> acho que 10% dessa nossa carteira (n√£o esque√ßa que podemos ter mais de uma carteira) √© um risco que pode valer a pena correr e por isso vou inclu√≠-lo.</p>
<p>Portanto, para este exemplo consideramos:</p>
<ul>
<li>TUPY3.SA: <a href="https://www.google.com/search?q=tupy3&amp;oq=tupy3&amp;aqs=chrome..69i57.7273j0j4&amp;sourceid=chrome&amp;ie=UTF-8">Tupy</a></li>
<li>ELET3.SA: <a href="https://www.google.com/search?ei=-dxuXtuyNIbR5OUPxY2m8AE&amp;q=ELET3.SA&amp;oq=ELET3.SA&amp;gs_l=psy-ab.3..0.40045.41040..41701...0.2..0.123.237.0j2......0....2j1..gws-wiz.......0i71.a2fjObIM6cM&amp;ved=0ahUKEwibk86a8p3oAhWGKLkGHcWGCR4Q4dUDCAs&amp;uact=5">Centrais Eletricas Brasileiras SA</a></li>
<li>BTC-USD: <a href="https://www.google.com/search?ei=JN1uXsDJLJm55OUPj8-c8As&amp;q=bitcoin&amp;oq=bitcoin&amp;gs_l=psy-ab.3.0.0i131i70i258j0i131i67j0i131j0i67j0j0i67j0i131j0i67j0j0i131.25383.26281..27215...0.0..0.175.1147.1j8......0....1..gws-wiz.xu0EQx1CnXI">Bitcoin</a></li>
</ul>
<pre class="r"><code>portifolio = c(&quot;TUPY3.SA&quot;,&quot;ELET3.SA&quot;, &quot;BTC-USD&quot;)</code></pre>
<div class="w3-panel w3-pale-red w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>AVISO</strong>: Volto a frisar que as escolhas das a√ß√µes foram feitas de forma arbitr√°ria. Estamos em tempos de incerteza atualmente por conta do corona v√≠rus (espero que todos fiquem bem) o que leva algumas escolhas √† serem ainda mais complexas e imprevis√≠veis.</p>
</div>
<div id="obter-dados" class="section level4">
<h4>Obter dados</h4>
<p>A aquisi√ß√£o das s√©rie hist√≥ricas das cota√ß√µes destes ativos desde 01/01/2016 foram obtidas utilizando o pacote <a href="https://github.com/business-science/tidyquant"><code>tidyquant</code></a> que nos retorna os dados das cota√ß√µes das a√ß√µes informadas em formato ‚Äúarrumado‚Äù (ou seja, familiar com fun√ß√µes do <a href="https://www.tidyverse.org/">tidyverse</a>), veja:</p>
<pre class="r"><code>library(tidyquant) # aquisicao de dados financeiros
stocks &lt;-map_df(portifolio, ~tq_get(.x, get = &quot;stock.prices&quot;, from = &quot; 2016-01-01&quot;))
saveRDS(stocks, &quot;stocks.rds&quot;)</code></pre>
<p>Veja as linhas iniciais do dataset obtido:</p>
<pre class="r"><code>stocks %&gt;% head() %&gt;% kable2()</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/img1.png" style="width:80.0%" />
</center>
<p>Existem uma s√©rie de vantagens de se trabalhar com os dados neste formato em R, veremos o porque nas pr√≥ximas se√ß√µes.</p>
</div>
<div id="arrumar-dataset" class="section level4">
<h4>Arrumar dataset</h4>
<p>O formato <a href="https://github.com/tidyverts/tsibble"><code>tsibble</code></a> √© um formato moderno para se trabalhar com s√©ries temporais trazendo a filosofia do <code>tidyverse</code> para os dados de s√©ries temporais facilitando o <a href="https://blog.earo.me/2018/12/20/reintro-tsibble/">fluxo de trabalho</a>.</p>
<p>Diversos outros pacotes podem ser combinados utilizando os dados no formato do pacote <code>tsibble</code> como os pacotes <a href="https://robjhyndman.com/hyndsight/fable/"><code>fable</code></a> e o <a href="https://github.com/mitchelloharawild/fable.prophet"><code>prophet</code></a> (sugiro a leitura para quem nao conhece) para aplica√ß√£o de modelagem de s√©ries temporais.</p>
<p>Veja como √© o fluxo ao trabalhar com objetos do tipo <code>tsibble</code></p>
<center>
<img src="/post/2020-03-25-investment-alert/ds-pipeline.png" style="width:60.0%" />
</br>
<small>Fonte: <a href="https://blog.earo.me/2018/12/20/reintro-tsibble/" class="uri">https://blog.earo.me/2018/12/20/reintro-tsibble/</a></small>
</center>
<p></br></p>
<pre class="r"><code>library(tsibble) # series temporais arrumadas
tbl_stocks &lt;- stocks %&gt;% as_tsibble(key = symbol, index = date) </code></pre>
<p>Ap√≥s importar e arrumar o dataset, seguimos para os pr√≥ximos passos.</p>
</div>
<div id="transformar" class="section level4">
<h4>Transformar</h4>
<p>Ap√≥s converter para <code>tsibble</code>, vamos preencher alguns gaps da bolsa como por exemplo os finais de semana (quando a bolsa de valores fica fechada) com o mesmo valor do dia anterior (Para este exemplo vamos fazer esse preenchimento dos gaps do final de semana mas n√£o √© sempre √© necess√°rio):</p>
<pre class="r"><code>tbl_stocks &lt;- 
  tbl_stocks %&gt;% 
  fill_gaps() %&gt;% 
  tidyr::fill(c(open, high, low, close, volume, adjusted),.direction = &quot;down&quot;)</code></pre>
<p>Com os dados arrumados vamos a algumas visualiza√ß√µes.</p>
</div>
<div id="visualizar" class="section level4">
<h4>Visualizar</h4>
<p>Vejamos qual foi o comportamento das s√©ries hist√≥ricas que coletamos desde o in√≠cio de 2016:</p>
<pre class="r"><code>library(forecast) # series temporais
library(fpp3)     # series temporais
d2 &lt;- 
  tbl_stocks %&gt;% 
  group_by(symbol) %&gt;% 
  summarise(y = mean(close))

autoplot(tbl_stocks)+
  geom_line(aes(group = symbol), color = &quot;black&quot;, show.legend = F) + 
  facet_wrap(~symbol, scales = &quot;free_y&quot;, ncol = 1)+
  geom_ma(n=6*30, color = &quot;red&quot;) + 
  theme(legend.position = &quot;none&quot;)+
  labs(subtitle = &quot;m√©dia m√≥vel n = 6 meses&quot;,
       caption = &quot;gomesfellipe.github.io&quot;)</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/unnamed-chunk-10-1.png" style="width:80.0%" />
</center>
<p>Note que a s√©rie do Bitcoin √© a mais imprevis√≠vel, houve um pico em 2018 mas ap√≥s isso n√£o houve nenhum grande pico como aquele. Em breve ocorrer√° o <a href="https://www.infomoney.com.br/onde-investir/halving-conheca-o-processo-que-pode-levar-o-bitcoin-a-uma-nova-explosao-de-preco/">Halving</a> (a contagem regressiva pode acompanhada <a href="https://www.bitcoinblockhalf.com/">neste link</a>) que √© um processo de choque de oferta e ocorre aproximadamente a cada 4 anos e pode ser uma boa oportunidade de retorno.</p>
<p>As duas s√©ries da bolsa de valores n√£o parecem ter uma correla√ß√£o muito forte, os picos ocorrem de forma alternada e isto pode ser uma caracter√≠stica boa para a carteira pois caso uma delas entre em crise a outra poder√° estar em uma fase boa.</p>
<div class="w3-panel w3-pale-blue w3-border">
<p><i class="fa fa-ambulance" aria-hidden="true"></i> Nota: Esta queda abrupta que ocorreu na bolsa no in√≠cio de 2020 √© o reflexo da <a href="https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_no_Brasil">Pandemia CODVID-19</a> que j√° come√ßou a apresentar alguns casos no Brasil e isso certamente tem gerando muita incerteza na bolsa de valores. Nem eu nem ningu√©m sabe o que pode acontecer, estou na torcida para que todos fiquem bem e pelo sucesso na conten√ß√£o desse v√≠rus! <i class="fas fa-praying-hands"></i></p>
</div>
</div>
<div id="correla√ß√µes" class="section level4">
<h4>Correla√ß√µes</h4>
<p>Para estudar melhor as conjecturas formadas ao observar o comportamento das s√©ries hist√≥rias (de que os picos e vales se alternam) vamos conferir olhada nos gr√°ficos de dispers√£o e coeficientes de <a href="https://pt.wikipedia.org/wiki/Coeficiente_de_correla%C3%A7%C3%A3o_de_postos_de_Spearman">correla√ß√£o de Spearman</a>:</p>
<pre class="r"><code>points_loess &lt;- function(data, mapping){
  ggplot(data = data, mapping = mapping) + 
    geom_point(alpha = 0.3,size=0.5) + 
    geom_smooth(method = &quot;loess&quot;)
}

tbl_stocks %&gt;%
  as_tibble() %&gt;% 
  select(symbol, date, close) %&gt;% 
  spread(key = symbol, value = close) %&gt;%
  GGally::ggpairs(columns = 2:4,
                  upper = list(continuous = GGally::wrap(&quot;cor&quot;, method = &quot;spearman&quot;)),
                  lower = list(continuous =  points_loess))</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/unnamed-chunk-11-1.png" style="width:80.0%" />
</center>
<p>Note que a rela√ß√£o entre TUPY3 e ELET3 n√£o √© linear e al√©m disso essa correla√ß√£o √© fraca, o que pode ser ben√©fico para o portf√≥lio pois uma poss√≠vel queda em uma n√£o parece n√£o ter tanto impacto na outra.</p>
<p>Al√©m disso note que a correla√ß√£o do BTC-USD com TUPY3 e ELET3 √© moderada e mesmo apresentando este valores num√©ricos, o Bitcoin √© um ativo negociado em escala global e √© de um setor totalmente diferente das outras a√ß√µes.</p>
<div class="w3-panel w3-pale-red w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>AVISO</strong>: Essa an√°lise meramente num√©rica n√£o √© o suficiente para detectar uma rela√ß√£o de causa, pois correla√ß√£o n√£o implica causalidade. Isto que dizer que poda haver uma causa em comum para ambas ou que seja uma <a href="https://pt.wikipedia.org/wiki/Regress%C3%A3o_esp%C3%BAria">correla√ß√£o esp√∫ria</a>. Quando se trata da bolsa de valores √© necess√°rio tamb√©m conhecer um pouco sobre a situa√ß√£o e hist√≥ria da empresa na qual se investe.</p>
</div>
</div>
<div id="forecast-com-prophet-do-facebook" class="section level4">
<h4>Forecast com Prophet do Facebook</h4>
<p>Poder√≠amos utilizar uma s√©rie de modelos estat√≠sticos, econom√©tricos e de machine learning utilizando tanto as fun√ß√µes nativas do R base ou pacote forecast quanto as fun√ß√µes desenvolvidas para trabalhar de maneira ‚Äúarrumada‚Äù com tsibble mas resolvi fazer uma abordagem diferente neste post escolhendo o modelo disponibilizado pelo Facebook.</p>
<div class="row">
<div class="column">
<p></br>
O <a href="https://facebook.github.io/prophet/">Prophet</a> √© um software de c√≥digo aberto disponibilizado pela equipe de <a href="https://research.fb.com/category/data-science/">Data Science do Facebook</a> que fornece um procedimento para realiza√ß√£o de previs√µes de dados de s√©ries temporais.</p>
</div>
<div class="column">
<p><img src="/post/2020-03-25-investment-alert/prophet_logo.png" style="width:80.0%" />
</br><small>Fonte: <a href="https://facebook.github.io/prophet/" class="uri">https://facebook.github.io/prophet/</a></small></p>
</div>
</div>
<p>Segundo a <a href="https://facebook.github.io/prophet/">documenta√ß√£o oficial</a>, (em tradu√ß√£o livre):</p>
<blockquote>
<p>O Prophet tem como ‚Äúbase em um modelo aditivo no qual tend√™ncias n√£o lineares se ajustam √† sazonalidade anual, semanal e di√°ria, al√©m de efeitos de f√©rias. Funciona melhor com s√©ries temporais que t√™m fortes efeitos sazonais e v√°rias temporadas de dados hist√≥ricos. O Profeta √© robusto para a falta de dados e mudan√ßas na tend√™ncia, e geralmente lida bem com outliers‚Äù.</p>
</blockquote>
<p>Este modelo me pareceu uma boa op√ß√£o para exemplificar a etapa da modelagem de s√©ries temporais deste post. Vamos ver o que o modelo do Facebook tem a nos dizer sobre o futuro das nossas a√ß√µes.</p>
<div id="divis√£o-entre-treino-e-teste-em-s√©ries-temporais" class="section level5">
<h5>Divis√£o entre treino e teste em s√©ries temporais</h5>
<p>Assim como em uma tarefa de machine learning que n√£o envolvem dados temporais, no caso de s√©ries temporais, quando desejamos avaliar o ajuste do nosso modelo tamb√©m dividimos o dataset em treino e teste por√©m utilizamos a data como √≠ndice.</p>
<p>Veja como ser√£o divididas nossas s√©ries hist√≥ricas:</p>
<ul>
<li>treino: inicio da s√©rie at√© 18/11/20;</li>
<li>teste: de 18/11/2020 at√© o final da s√©rie hist√≥rica (2 meses atr√°s)</li>
</ul>
<pre class="r"><code>h = 30 * 2
data_split &lt;- Sys.Date() - h

tbl_stocks_train &lt;-  
  tbl_stocks %&gt;% 
  filter(date &lt;= data_split) %&gt;% 
  select(symbol, date, close)

tbl_stocks_test &lt;- 
  tbl_stocks %&gt;%
  filter(date &gt; data_split) %&gt;% 
  select(symbol, date, close)</code></pre>
<p>Ap√≥s dividir os dados em treino e teste j√° estamos habilitados √† utilizar o modelo. Note que, por default, o modelo espera duas colunas nomeadas como <code>ds</code>: data da s√©rie e <code>y</code>: vari√°vel target da s√©rie.</p>
<p>Al√©m disso faremos uma previs√£o 6 meses a frente dos dados de teste para entender qual a tend√™ncia o modelo estaria adotando.</p>
<pre class="r"><code>library(prophet)

prophet_results &lt;- 
  tbl_stocks_train %&gt;% 
  rename(ds = date, y = close) %&gt;% 
  nest(data = c(ds, y)) %&gt;% 
  mutate(pmodel = map(data, ~ prophet(.x, daily.seasonality=TRUE))
  )%&gt;% 
  mutate(pprediction = map(pmodel, ~.x %&gt;%  
                             make_future_dataframe(periods = h + 30*6) %&gt;%
                             predict(.x,.))) </code></pre>
<p>Veja os resultados do ajuste do modelo:</p>
<pre class="r"><code>library(patchwork)

pmap(list(
  x = prophet_results$pprediction,
  y = split(tbl_stocks_train, tbl_stocks_train$symbol),
  z = split(tbl_stocks_test, tbl_stocks_test$symbol),
  w = prophet_results$symbol
),function(x, y, z, w){
  x %&gt;% 
    as_tibble() %&gt;%
    mutate(ds=as_date(ds)) %&gt;%
    select(ds, trend, yhat, yhat_lower, yhat_upper) %&gt;% 
    ggplot() + 
    geom_line(aes(x=ds, y=yhat, color=&quot;blue&quot;), show.legend = F) +
    geom_line(data=y, aes(x=date, y=close, color=&quot;black&quot;), show.legend = F) +
    geom_line(data=z, aes(x=date, y=close, color=&quot;red&quot;), show.legend = T) +
    geom_ribbon(aes(x=ds, ymin=yhat_lower, ymax=yhat_upper), alpha=0.2)  +
    scale_x_date(#limits = c(as.Date(&quot;2018-06-01&quot;), Sys.Date() + 30*12), 
      date_breaks = &quot;6 month&quot;, date_labels = &quot;%m/%Y&quot;) +
    theme_bw()+
    labs(y = w, x = &quot;&quot;, caption = &quot;gomesfellipe.github.io&quot;)+
    scale_colour_manual(values=c(&quot;black&quot;,&quot;blue&quot;,&quot;red&quot;), name=&quot;&quot;, labels=c(&quot;treino&quot;,&quot;modelo&quot;,&quot;teste&quot;))+
    theme(legend.position = c(1-0.8,1-0.2), 
          legend.background = element_rect(fill=alpha(&#39;lightgrey&#39;, 0.2)),
          legend.direction = &quot;horizontal&quot;)
}
) %&gt;% {.[[1]] / .[[2]] / .[[3]]}

ggsave(&quot;prophet.png&quot;) # salvar para o bot retornar este resultado!</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/unnamed-chunk-15-1.png" style="width:80.0%" />
</center>
<p>Parece interessante..</p>
<p>Veja que a linha azul (modelo ajustado) se ajusta bem √† linha preta (dados de treino) acompanhando a s√©rie hist√≥rica e captando algumas tend√™ncias n√£o lineares.</p>
<p>Por√©m note que a linha azul se perde completamente da linha vermelha (dados de teste) no in√≠cio de 2020 e acho isso muito razo√°vel pois dificilmente algum modelo iria prever os efeitos de uma Pandemia utilizando apenas a s√©rie hist√≥rica do ativo.</p>
<p>Note ainda que a linha azul se estende at√© o final de 2020 (previs√µes para os pr√≥ximos 6 meses) o que sugere que a s√©rie possu√≠a esta tendencia positiva ao longo dos anos, segundo o modelo Prophet .</p>
<div class="w3-panel w3-pale-yellow w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>Aviso</strong>: Existem v√°rias maneiras de estudar e melhorar a qualidade do ajuste deste modelo mas como o objetivo deste post n√£o √© este deixo como aviso para o leitor.</p>
</div>
<p>Com a interpreta√ß√£o dos resultados conclu√≠da.. vamos √†s compras!</p>
</div>
</div>
</div>
</div>
</div>
<div id="comprando-a√ß√µes" class="section level1">
<h1>Comprando a√ß√µes</h1>
<p>Ap√≥s toda essa exemplifica√ß√£o de como podem ser feitas as an√°lises para a elabora√ß√£o da carteira chegou a hora das compras.</p>
<p>Suponha que tiv√©ssemos realizado nossas compra no fechamento do dia <strong>2018-12-01</strong>, quando os valores de <font color="blue"><strong>fechamento</strong></font> das cota√ß√µes eram as seguintes:</p>
<pre class="r"><code>tbl_stocks %&gt;% 
  filter(date == &quot;2018-12-01&quot;) %&gt;% 
  mutate(close = cell_spec(moeda_real(close), &quot;html&quot;, color = &quot;blue&quot;, bold = T)) %&gt;% 
  mutate_at(c(3:5, 8), ~moeda_real(.x)) %&gt;% 
  kable2()</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/img2.png" style="width:80.0%" />
</center>
<p>Neste dia a cota√ß√£o para ELET3 era R$24,42 e TUPY3 era R$19,73 e suponha que tenhamos comprado 200 lotes de ELET3 e 150 fracion√°rios de TUPY, totalizando R$7.843,64 (pr√≥ximo ao que tinhaamos planejado no inicio do estudo)</p>
<p>Vamos guardar estes valores:</p>
<pre class="r"><code>cot_inicio = filter(tbl_stocks, date == &quot;2018-12-01&quot;, symbol != &quot;BTC-USD&quot;) %&gt;% pull(close)
qtd_inicio = c(elet = 200, tupy = 150)</code></pre>
<p>Note que o valor do Bitcoin est√° em d√≥lares, para obter o valor em reais (R$) daquele dia vamos utilizar a <a href="https://www.mercadobitcoin.net/api/BTC/day-summary/2020/01/09/">API do Mercado Bitcoin</a>. Como n√£o existe nenhum pacote que forne√ßa estes dados diretamente no R, a requisi√ß√£o ser√° feita normalmente via API com o pacote <code>jsonlite</code>:</p>
<pre class="r"><code>library(jsonlite) # requisicao de api
url &lt;- glue::glue(&quot;https://www.mercadobitcoin.net/api/BTC/day-summary/2019/12/01/&quot;)
safe_fromJSON &lt;- purrr:::safely(fromJSON, as.numeric(NA)) 
consulta &lt;- safe_fromJSON(url)$result %&gt;% map_dfc(~.x)

consulta %&gt;%
  select(-date) %&gt;% 
  mutate_all(~moeda_real(.x)) %&gt;%
  mutate(closing = cell_spec(closing, &quot;html&quot;, color = &quot;blue&quot;)) %&gt;% 
  kable2()</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/img3.png" style="width:80.0%" />
</center>
<p>O pre√ßo de fechamento foi de R$31.747,38 e suponhamos que tenha sido este o valor pago no dia. (Parece que neste dia o d√≥lar estava em torno de R$4,03)</p>
<p>Para completar esta carteira fict√≠cia vamos adquirir 0,0032 do valor de um Bitcoin</p>
<pre class="r"><code>cot_inicio[3] &lt;- consulta$closing
qtd_inicio[3] &lt;- 0.032</code></pre>
<p>Portanto, ao valor de R$31.747,38 compramos 0.032 Bitcoin totalizando R$1.015,92 completando nossa carteira.</p>
<div id="tabela-financeira" class="section level2">
<h2>Tabela financeira</h2>
<p>Semelhante a uma planilha financeira, criaremos uma tabela financeira automatizada que receber√° como input os valores da montagem e calcular√° automaticamente os valores do desmontagem no tempo atual utilizando dados de APIs abertas.</p>
<blockquote>
‚ÄúAquilo que n√£o se pode medir, n√£o se pode melhorar‚Äù.
<div align="right">
<font size="1">F√≠sico irland√™s William Thomson</font>
</div>
</blockquote>
<p>Primeiro √© necess√°rio obter os valores mais recentes das cota√ß√µes das acoes que compramos na bolsa e para isto ser√° necess√°rio utilizar outro pacote pois o <code>tidyquant</code> s√≥ fornece os dados em frequ√™ncia di√°ria.</p>
<p>Utilizaremos portanto, o pacote <a href="https://www.business-science.io/code-tools/2017/09/03/alphavantager-0-1-0.html">alphavantager</a> que fornece dados de finan√ßas da API gratuita <a href="https://www.alphavantage.co/">Alpha Vantage</a> no formato arrumados e tamb√©m foi desenvolvida pela <a href="https://github.com/business-science">Business Science</a> (mesmo criados do pacote <code>tidyquant</code>).</p>
<div class="w3-panel w3-pale-yellow w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>Aviso</strong>: Na <a href="https://www.alphavantage.co/support/#api-key">documenta√ß√£o da api do Alphavantage</a> recomenda-se a solicita√ß√µes de API com modera√ß√£o, suportando at√© 5 solicita√ß√µes de API por minuto e 500 solicita√ß√µes por dia para obter o melhor desempenho no servidor. Caso deseje segmentar um volume maior de chamadas da API, confira a <a href="https://www.alphavantage.co/premium/">associa√ß√£o premium.</a>.</p>
</div>
<p>J√° para a coleta da cota√ß√£o em tempo real do Bitcoin em reais (R$), utilizaremos novamente a <a href="https://www.mercadobitcoin.com.br/api-doc/?">api do mercado bitcoin</a>.</p>
<pre class="r"><code># Importar dados da bolsa de valores ==================================

library(alphavantager) # api streaming bovespa

AV_API_KEY = Sys.getenv(&quot;AV_API_KEY&quot;)
av_api_key(AV_API_KEY)

consulta_acoes &lt;- map_df(portifolio[1:2], ~{
  alphavantager::av_get(symbol = .x,
         av_fun = &quot;TIME_SERIES_INTRADAY&quot;,
         interval = &quot;1min&quot;,  # &quot;1min&quot;, &quot;5min&quot;, &quot;15min&quot;, &quot;30min&quot; ou &quot;60min&quot;
         outputsize = &quot;compact&quot;) %&gt;%  # &quot;full&quot;
    bind_cols(stock = rep(.x, nrow(.)))
})

# Impotar dados do bitcoin ============================================

coin &lt;- &quot;BTC&quot;
method &lt;- &quot;ticker&quot;
url &lt;- glue::glue(&quot;https://www.mercadobitcoin.net/api/{coin}/{method}/&quot;)

safe_fromJSON &lt;- safely(fromJSON, as.numeric(NA)) 
consulta_bitcoin &lt;- 
  safe_fromJSON(url)$result$ticker %&gt;% 
  as_tibble() %&gt;% 
  transmute(timestamp = lubridate::ymd_hms(as.POSIXct(date, origin=&quot;1970-01-01&quot;)),
            open, high, low, close = sell, volume = NA, stock = &quot;BTC.BR&quot;) %&gt;% 
  mutate_at(c(&#39;open&#39;, &#39;high&#39;, &#39;low&#39;, &#39;close&#39;), ~as.numeric(.x))

# Combinar resultados das consultas ==================================

consulta_atual &lt;- 
  bind_rows(
    consulta_acoes %&gt;% 
      group_by(stock) %&gt;% 
      filter(timestamp == last(timestamp)),
    consulta_bitcoin
  ) 

# Salvar consulta ====================================================
saveRDS(consulta_atual, &quot;consulta_atual.rds&quot;)</code></pre>
<p>Resultados da consulta atual (ap√≥s combinar a requisi√ß√£o da bolsa de valores e do Mercado Bitcoin):</p>
<pre class="r"><code>consulta_atual  %&gt;%
  mutate_at(2:4, ~moeda_real(.x)) %&gt;% 
  mutate_if(is.numeric, ~ifelse(is.na(.x), &quot;-&quot;, format(.x, digits = 2))) %&gt;% 
  mutate(close = cell_spec(moeda_real(close), &quot;html&quot;, color = &quot;blue&quot;)) %&gt;% 
  kable2()</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/img4.png" style="width:80.0%" />
</center>
<p>Com os valores da Montagem organizados e os valores da Desmontagem coletados em tempo real j√° podemos construir nossa tabela financeira automatizada.</p>
<p>A tabela cont√©m:</p>
<ul>
<li>Valores de cota√ß√£o e quantidade adquiridas de cada uma no momento da montagem da carteira;</li>
<li>Valores de cada cota√ß√£o no momento atual com suas respectivas quantidades dispon√≠veis;</li>
<li>Resultados de o ganho (ou perda) seguido do resultado bruto caso realize a venda agora;</li>
<li>√öltima coluna indica se vale a pena vender ou n√£o aquela cota√ß√£o considerando que o valor de venda √© superior ao valor de compra.</li>
</ul>
<div class="w3-panel w3-pale-yellow w3-border">
<p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>Aviso</strong>: Essa opera√ß√£o de vender o ativo caso o pre√ßo da venda seja maior que o da compra √© apenas um exemplo. Poder√≠amos utilizar diversas estat√≠sticas para determinar o momento da opera√ß√£o por√©m adotei esta apenas para ilustrar o funcionamento da tabela financeira, o limite de op√ß√µes √© a sua criatividade!</p>
</div>
<p>Veja a tabela final com os resultados atualizados em tempo real:</p>
<pre class="r"><code>porcentagem &lt;- function(x){paste0(round(x,2), &quot;%&quot;)} # Funcao auxiliar

# Tabela resultado
financas &lt;- 
  tibble(
    ativo = portifolio,
    cot_inicio = cot_inicio,
    qtd_inicio = qtd_inicio,
    vol_inicio = cot_inicio * qtd_inicio,
    cot_atual = consulta_atual$close,
    qtd_atual = qtd_inicio,
    vol_atual = cot_atual * qtd_atual,
    ganho_perda = vol_atual - vol_inicio,
    resultado_bruto = ganho_perda / vol_inicio * 100
  ) 


tabela &lt;- 
  financas %&gt;% 
  mutate(
    cot_inicio = moeda_real(cot_inicio),
    cot_atual = moeda_real(cot_atual),
    vol_inicio = moeda_real(vol_inicio),
    vol_atual = moeda_real(vol_atual),
    qtd_inicio = round(qtd_inicio,4),
    qtd_atual = round(qtd_atual,4),
    ` ` = ifelse(ganho_perda &gt; 0,&quot;\u2713&quot;, &quot;\u2718&quot;) ,
    cot_atual = cell_spec(cot_atual, &quot;html&quot;, color = &quot;blue&quot;),
    ganho_perda = cell_spec(moeda_real(ganho_perda), &quot;html&quot;,
                            color = ifelse(ganho_perda &gt; 0, 
                                           &quot;green&quot;, &quot;red&quot;)),
    resultado_bruto = cell_spec(porcentagem(resultado_bruto), &quot;html&quot;,
                                color = ifelse(resultado_bruto &gt; 0, 
                                               &quot;green&quot;, &quot;red&quot;))) %&gt;% 
  `colnames&lt;-`(stringr::str_replace_all(colnames(.), &quot;(_|[[:space:]])&quot;, &quot;\n&quot;)) %&gt;% 
  # Exibicao
  kable(format = &quot;html&quot;, escape = F) %&gt;%
  kable_styling(c(&quot;striped&quot;, &quot;bordered&quot;, &quot;hover&quot;, &quot;responsive&quot;), full_width = T, font_size = 12) %&gt;%
  add_header_above(c(&quot; &quot;, &quot;Montagem&quot; = 3,
                     &quot;Desmontagem / Atual&quot; = 3, &quot;Resultado&quot; = 3))

tabela</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/img5.png" style="width:80.0%" />
</center>
<p>Agora que j√° possu√≠mos nossa requisi√ß√£o completa e arrumada em tempo real precisamos ter acesso a esta informa√ß√£o de forma din√¢mica tamb√©m e para isso utilizaremos o bot do Telegram.</p>
</div>
</div>
<div id="bot-telegram" class="section level1">
<h1>Bot Telegram</h1>
<p>Depois de muitas decis√µes tomadas enfim chegamos ao bot! Espero que tenha notado que montar uma carteira n√£o √© uma tarefa f√°cil pois envolve exposi√ß√£o ao risco e tamb√©m exige certo acompanhamento do mercado.</p>
<div class="row">
<div class="column8">
<p></br>
Para criar um bot no Telegram basta seguir os passos do <a href="https://github.com/lbraglia/telegram">readme</a> do pacote <a href="https://github.com/lbraglia/telegram"><code>telegram</code></a> disponibilizado no Github ou seguir os passos desse excelente <a href="https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/">post do curso-r</a> que me inspirou a uns anos atras e hoje me auxiliou novamente para criar este bot. Ao concluir a etapa de configura√ß√£o teremos um novo contado no Telegram, o nosso bot!</p>
<p>Com a configura√ß√£o no aplicativo do Telegram conclu√≠da, o primeiro passo para configurar as a√ß√µes do bot no R √© iniciar um objeto TGBot declarando o id do seu bot. No meu caso o bot se chama <em>Stocks</em> e o id √© <em>fgstockbot</em>.</p>
</div>
<div class="column4">
</br>
<center>
<img src="/post/2020-03-25-investment-alert/bot_telegram.png" style="width:99.0%" />
</center>
</div>
</div>
<p>Com o R conectado ao bot do Telegram j√° somos capazes de criar um conjunto de regras de forma que o bot nos retorne as informa√ß√µes que desejamos.</p>
<p>Desenvolveremos a fun√ß√£o <code>report_stocks()</code> que programa o bot para realizar o seguinte algoritmo:</p>
<ol start="0" style="list-style-type: decimal">
<li>Carregar depend√™ncias e conectar chaves de acesso</li>
<li>Conferir se a bolsa de valores esta aberta</li>
<li>Requisi√ß√£o das cota√ß√µes da bolsa de valores em <em>real-time</em></li>
<li>Requisi√ß√£o da cota√ß√£o do Bitcoin em <em>real-time</em></li>
<li>Combinar resultados</li>
<li>Inserir resultados da coleta na tabela financeira</li>
<li>Se o valor de algum volume atual seja maior que o volume inicial:
<ul>
<li>Calcular valores de desmontagem</li>
<li>Preparar layout da tabela financeira</li>
<li>Salvar resultados</li>
<li>Enviar via Telegram</li>
</ul></li>
<li>Aguardar 20 minutos para a pr√≥xima requisi√ß√£o</li>
<li>Repetir todo o processo</li>
</ol>
<p>Parece complicado mas √© tranquilo pois todos os c√≥digos de cada uma destas tarefas j√° foram desenvolvidos nas se√ß√µes anteriores e ser√£o apenas combinados. A fun√ß√£o <a href="https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929"><code>report_stocks()</code> j√° esta dispon√≠vel no github</a>, veja a baixo:</p>
<p>(A frequ√™ncia adotata como default pela fun√ß√£o tenta fazer a requisi√ß√£o com a maior frequ√™ncia poss√≠vel na api do Alphavantage)</p>
<script src="https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929.js"></script>
<p>Ap√≥s todas as devidas configura√ß√µes, basta carregar a fun√ß√£o e executar para obter o seguinte resultado:</p>
<pre class="r"><code># https://gist.github.com/gomesfellipe/357af0735d2aedca60146a7655e33929
devtools::source_gist(&quot;357af0735d2aedca60146a7655e33929&quot;,quiet = T)

# Executar
bot_report_stocks(portifolio = portifolio, 
                  cot_inicio = cot_inicio,
                  qtd_inicio = qtd_inicio)</code></pre>
<center>
<img src="/post/2020-03-25-investment-alert/report_stocks.gif" style="width:70.0%" />
</center>
<p></br>
E assim obtemos um feedback atrav√©s do nosso Smartphone ou Smartwatch em tempo real sobre o desempenho da nossa carteira!</p>
</div>
<div id="conclus√£o-e-pr√≥ximos-passos" class="section level1">
<h1>Conclus√£o e pr√≥ximos passos</h1>
<p>Neste post criamos um bot que coleta os dados e faz an√°lises disponibilizando-as em tempo real no Telegram. Por√©m vimos tamb√©m o qu√£o dif√≠cil pode ser a montagem de uma carteira e as an√°lises envolvendo s√©ries hist√≥ricas de ativos.</p>
<p>Diante dos resultados obtidos aqui existe uma grande gama de op√ß√µes de inova√ß√µes para trabalhos futuros como:</p>
<ul>
<li>Programar o bot para responder a uma <a href="https://support.apple.com/pt-br/guide/watch/apd92a90f882/watchos">menssagem r√°pida no smartwatch</a> com o valor de uma previs√£o;</li>
<li>Desenvolver um Shiny parametrizando o bot para consultar an√°lises em tempo real;</li>
<li>Hospedar a rotina em um servidor para operacionalizar o bot (caso tenha d√∫vidas de como se iniciar um RStudio Server u um Shiny Server <a href="https://gomesfellipe.github.io/post/2018-10-27-server-cloud/server-cloud/">consulte este post do blog</a>);</li>
<li>Criar uma API com <a href="https://www.rplumber.io">plumber</a> para fornecer os resultados;</li>
<li>Treinar modelo utilizando mais dados, mais vari√°veis explicativas e tuning dos par√¢metros;</li>
<li>Criar pacote com um rob√¥ mais geral para responder diferentes consultas.</li>
</ul>
<p>Espero que tenha gostado qualquer d√∫vida deixe nos coment√°rios!</p>
</div>
<div id="refer√™ncias" class="section level1">
<h1>Refer√™ncias</h1>
<ul>
<li><a href="https://www.infomoney.com.br/minhas-financas/brasileiros-nao-sabem-a-diferenca-entre-poupar-e-investir-afirma-especialista-2/" class="uri">https://www.infomoney.com.br/minhas-financas/brasileiros-nao-sabem-a-diferenca-entre-poupar-e-investir-afirma-especialista-2/</a></li>
<li><a href="https://www.btgpactualdigital.com/blog/investimentos/diversificacao-de-investimentos" class="uri">https://www.btgpactualdigital.com/blog/investimentos/diversificacao-de-investimentos</a></li>
<li><a href="https://www.btgpactualdigital.com/blog/coluna-gustavo-cerbasi/defina-sua-estrategia-entre-renda-fixa-ou-variavel" class="uri">https://www.btgpactualdigital.com/blog/coluna-gustavo-cerbasi/defina-sua-estrategia-entre-renda-fixa-ou-variavel</a></li>
<li><a href="https://blog.earo.me/2018/12/20/reintro-tsibble/" class="uri">https://blog.earo.me/2018/12/20/reintro-tsibble/</a></li>
<li><a href="https://www.tradingcomdados.com/post/2017/07/09/estudo-de-correla%C3%A7%C3%A3o-entre-a%C3%A7%C3%B5es-da-bolsa-de-valores-de-s%C3%A3o-paulo" class="uri">https://www.tradingcomdados.com/post/2017/07/09/estudo-de-correla%C3%A7%C3%A3o-entre-a%C3%A7%C3%B5es-da-bolsa-de-valores-de-s%C3%A3o-paulo</a></li>
<li><a href="https://www.business-science.io/code-tools/2017/10/28/demo_week_h2o.html" class="uri">https://www.business-science.io/code-tools/2017/10/28/demo_week_h2o.html</a></li>
<li><a href="https://www.infomoney.com.br/mercados/adolescente-fica-milionario-aos-18-anos-usando-bitcoins-apos-fazer-aposta-com-os-pais/" class="uri">https://www.infomoney.com.br/mercados/adolescente-fica-milionario-aos-18-anos-usando-bitcoins-apos-fazer-aposta-com-os-pais/</a></li>
<li><a href="https://www.infomoney.com.br/onde-investir/halving-conheca-o-processo-que-pode-levar-o-bitcoin-a-uma-nova-explosao-de-preco/" class="uri">https://www.infomoney.com.br/onde-investir/halving-conheca-o-processo-que-pode-levar-o-bitcoin-a-uma-nova-explosao-de-preco/</a></li>
<li><a href="https://cran.r-project.org/web/packages/telegram/README.html" class="uri">https://cran.r-project.org/web/packages/telegram/README.html</a></li>
<li><a href="https://otexts.com/fpp2/" class="uri">https://otexts.com/fpp2/</a>
<a href="https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/" class="uri">https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/</a></li>
<li><a href="https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/" class="uri">https://www.curso-r.com/blog/2017-08-19-r-telegram-bitcoin/</a></li>
</ul>
</div>

        <p><strong>Leia o post completo em:</strong> <a href="https://gomesfellipe.github.io/post/2020-03-25-investment-alert/investment-alert/">Desenvolva um bot e receba resultados de Machine Learning no seu Smartphone para ajudar nos investimentos</a></p>
        <p><em>Este post foi originalmente publicado em <a href="https://gomesfellipe.github.io/">Fellipe Gomes - Data Science Blog</a></em></p>
      ]]></content:encoded>
      <category>Fundamentos de Data Science</category>
      <category>Intelig√™ncia Artificial</category>
      <category>Machine Learning</category>
      <category>Programa√ß√£o e Ferramentas</category>
      <category domain="tag">bitcoin</category>
      <category domain="tag">bolsa-de-valores</category>
      <category domain="tag">correlacao</category>
      <category domain="tag">dplyr</category>
      <category domain="tag">estatistica</category>
      <category domain="tag">machine-learning</category>
      <category domain="tag">modelagem</category>
      <category domain="tag">prophet</category>
      <category domain="tag">r</category>
      <category domain="tag">reports</category>
    </item>
    <item>
      <title>Seu app, RStudio e Shiny Server na nuvem do Google</title>
      <link>https://gomesfellipe.github.io/post/2018-10-27-server-cloud/server-cloud/</link>
      <pubDate>Sat, 27 Oct 2018 00:00:00 +0000</pubDate>
      <author>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</author>
      <guid>https://gomesfellipe.github.io/post/2018-10-27-server-cloud/server-cloud/</guid>
      <description>Uma maneira pr√°tica de hospedar o app desenvolvido no post no Shiny Server e ter seu pr√≥prio RStudio Server na nuvem do Google em uma m√°quina virtual Ubuntu 16.04.</description>
      <content:encoded>&lt;![CDATA[
        


<div id="objetivo-do-post" class="section level1">
<h1>Objetivo do post <i class="fa fa-rocket"></i></h1>
<p>Uma das v√°rias maneiras de se implementar o <a href="https://www.rstudio.com/products/rstudio/download-server/">RStudio Server</a> e o <a href="https://www.rstudio.com/products/shiny/download-server/">Shiny Server</a> √© atrav√©s de servi√ßos de nuvem que fornecem m√°quinas virtuais. Empresas gigantes no mercado como Amazon Web Services (AWS), Microsoft, Google, IBM, Oracle etc t√™m investido pesado nestes servi√ßos e a escolha de qual cloud utilizar deve ser feita de acordo com a necessidade do usu√°rio pois cada uma delas oferecem diferentes pre√ßos com diferentes custos/benef√≠cios.</p>
<p>No final deste post teremos al√©m do nosso pr√≥prio RStudio Server, esse app no Shiny Server que exibe em um gr√°fico das cota√ß√µes encontradas via fun√ß√£o fun√ß√£o <a href="https://www.rdocumentation.org/packages/TTR/versions/0.23-4/topics/stockSymbols"><code>quantmod::stockSymbols()</code></a> com os pacotes <a href="http://jkunst.com/highcharter/"><code>highcharter</code></a> e <a href="https://www.quantmod.com/"><code>quantmod</code></a>:</p>
<p><img src="/post/2018-10-27-server-cloud/server-cloud_files/demoapp.gif" /></p>
<p><strong>Nota</strong>: Algum conhecimento em Linux e Git pode ser √∫til, particularmente ainda tenho muito a aprender sobre ambos e devem existir outras maneiras mais eficientes de se realizar estas tarefas. Essa √© uma forma relativamente simples e ao final do post deixarei os links que utilizei como refer√™ncia para escrever este post.</p>
<p><strong>Nota¬≤</strong>, segundo o desenvolvedor do pacote <code>highcharter</code>: ‚Äú<em>Highcharts (www.highcharts.com) √© um produto de software da Highsoft que n√£o √© livre para uso comercial e governamental</em>‚Äù.</p>
</div>
<div id="gloogle-cloud" class="section level1">
<h1>Gloogle cloud <i class="fa fa-cloud"></i></h1>
<p>A servi√ßo que escolhi para este exemplo foi o <a href="https://cloud.google.com/">Google Cloud</a>, que oferece um <a href="https://cloud.google.com/free/docs/frequently-asked-questions">per√≠odo de um ano de Teste Gr√°tis com $300</a> para utilizar nos servi√ßos <a href="https://cloud.google.com/free/docs/frequently-asked-questions?hl=pt_BR&amp;_ga=2.209128081.-2022746393.1538697551&amp;_gac=1.3934980.1540514862.EAIaIQobChMImJjS9vCi3gIVEgaRCh0j3ArWEAAYASAAEgJ8AfD_BwE#always-free">dentre outras op√ß√µes</a>, mas isso n√£o quer dizer que seja a melhor de todas, sinta-se a vontade para utilizar os mesmos passos apresentados aqui nos demais servi√ßos, entendendo, claro, suas peculiaridades.</p>
<p>Dentre algumas vantagens sobre o uso de nuvem, temos:</p>
<ul>
<li>Maior produtividade, pois possibilita r√°pido acesso √† sua √°rea de trabalho;</li>
<li>Permite o desenvolvedor trabalhar de qualquer lugar com acesso √† internet;</li>
<li>Permite colabora√ß√£o r√°pida, pois os membros da equipe podem contribuir e acessar projetos ao mesmo tempo em que os dados s√£o armazenados na nuvem em vez de em seus computadores</li>
<li>Protegido pelos principais especialistas seguran√ßa do Google;</li>
<li>Controle e flexibilidade, o desenvolvedor tem controle sobre a tecnologia que deseja usar, sobre os dados e caso decida n√£o usar mais o servi√ßo, √© poss√≠vel retirar seus dados da nuvem do Google.</li>
</ul>
<div id="compute-engine" class="section level2">
<h2>Compute Engine <img src="/post/2018-10-27-server-cloud/server-cloud_files/compute_engine.png" style="width:5.0%" /></h2>
<p>Compute Engine √© um dos produtos oferecidos pelo Google. Tamb√©m conhecido como <a href="https://pt.wikipedia.org/wiki/Infraestrutura_como_servi%C3%A7o">infraestrutura como servi√ßo (IaaS)</a>, pode ser usada para executar altas cargas de trabalho em larga escala em m√°quinas virtuais, no nosso caso este produto que possibilita o uso das m√°quinas virtuais.</p>
</div>
</div>
<div id="iniciar-uma-inst√¢ncia-na-google-cloud-platform" class="section level1">
<h1>Iniciar uma inst√¢ncia na Google Cloud Platform</h1>
<p>Primeiramente, acesse <a href="https://cloud.google.com/" class="uri">https://cloud.google.com/</a> e se inscreva no recurso de nuvem, ap√≥s isso acesse <a href="https://console.cloud.google.com" class="uri">https://console.cloud.google.com</a> e percorra o caminho:</p>
<p><code>Menu de navega√ß√£o</code> ‚Üí <code>Compute Engine</code> ‚Üí <code>Inst√¢ncias de VMs</code></p>
<p>Nesta p√°gina existe o <img src="/post/2018-10-27-server-cloud/server-cloud_files/button_criar_instancia.png" />, clique nele para iniciar a configura√ß√£o da VM. Na p√°gina que abrir ser√° solicitado a dar um nome a sua VM (pode ser qualquer nome que te agrade). O Google tem data centers em quase todo o mundo e para este caso selecionei a <code>Regi√£o</code> <em>us-east1 (Carolina do Sul)</em> e a <code>Zona</code> deixei o default <em>us-east1-b</em>.<a href="https://cloud.google.com/free/docs/frequently-asked-questions?hl=pt_BR&amp;_ga=2.183970469.-2022746393.1538697551&amp;_gac=1.36440980.1540514862.EAIaIQobChMImJjS9vCi3gIVEgaRCh0j3ArWEAAYASAAEgJ8AfD_BwE#always-free">‚Äúsaiba mais‚Äù do Google</a>.</p>
<p>Dependendo de qu√£o poderoso o servidor precisa ser √© poss√≠vel selecionar a capacidade da RAM e do disco r√≠gido na se√ß√£o <code>Tipo de M√°quina</code>, como este √© um exemplo para prova de conceito selecionei a op√ß√£o <em>micro(1 vCPU compartilhado) - 0.6 GB de mem√≥ria, f1-micro</em> pois custa cerca de $ 0,006 por hora e as ‚Äúprimeiras 744 horas para uso da inst√¢ncia de tipo f1-micro s√£o gratuitas‚Äù, segundo o Google. No <code>Disco de inicializa√ß√£o</code> selecionei a <code>Imagen do SO</code> <em>Ubuntu 16.04 LTS</em> que tenho um pouco mais de familiaridade e n√£o mexi nas demais configura√ß√µes dessa se√ß√£o, mas antes de finalizar, selecione a op√ß√£o <em>Permitir tr√°fego HTTP</em> na op√ß√£o de <code>Firewall</code> e clique no bot√£o <code>criar</code>.</p>
<p>Segundo o guia <a href="https://support.rstudio.com/hc/en-us/articles/200552306-Getting-Started">Acessando o RStudio Server Open-Source</a> e o <a href="http://rstudio.github.io/shiny-server/os/0.4.0/">Guia do Administrador - Shiny Server Open Source v0.4.1</a>o RStudio Server e o Shiny Server ser√£o escutados nas portas 8787 e 3838 respectivamente, portanto, antes de come√ßar a usar a VM √© necess√°rio Configurando regras de firewall para permitir acesso atrav√©s destas portas.</p>
<p>Navegue at√© a se√ß√£o <code>Rede VPC</code> e selecione a op√ß√£o <code>Regras de firewall</code>. Clique em <img src="/post/2018-10-27-server-cloud/server-cloud_files/criar_firewall.png" />. No formul√°rio que abrir d√™ um nome e uma descri√ß√£o √† regra do firewall (‚Äòrstudio‚Äô est√° bom), deixe os bot√µes de op√ß√£o <code>Dire√ß√£o de tr√°fego</code> e <code>A√ß√£o ao corresponder</code> como padr√£o (<em>Entrada</em> e <em>Permitir</em>). Para a op√ß√£o <code>Destinos</code>, escolhi <em>Conta de servi√ßo especificado</em>, sendo a <code>Conta de servi√ßo de destino</code> <em>Compute Engine default service account</em>. Se voc√™ quiser filtrar os IPs que podem acessar o aplicativo, insira-o no campo <code>Intervalos de IP de origem</code>, como estamos sob uma prova de conceito, inseri a rota quad-zero: 0.0.0.0/0, o que permite acesso de todos os IPs em todas as portas nessa m√°quina. Na op√ß√£o <code>Protocolos e Portos</code> selecione o bot√£o de op√ß√£o <em>Protocolos e portas espec√≠ficas</em> e no campo digite o tcp: 8787. Por fim, clique no bot√£o <code>criar</code>.</p>
<p>Fa√ßa o procedimento exatamente da mesma maneira, mas com um novo nome (‚Äòshiny‚Äô est√° bom) e digite ‚Äòtcp: 3838‚Äô em vez de ‚Äòtcp: 8787‚Äô. Clique em <code>criar</code> e note que agora abrimos duas portas para usar no aplicativo.</p>
<p>Nota: <em>Os passos para iniciar uma inst√¢ncia na Cloud do Google foram inspirados no seguinte post:</em> <a href="https://datarunsdeep.com.au/blog/building-r-shiny-app-google-cloud-display-bigquery-data" class="uri">https://datarunsdeep.com.au/blog/building-r-shiny-app-google-cloud-display-bigquery-data</a></p>
</div>
<div id="inicie-a-m√°quina-virtual" class="section level1">
<h1>Inicie a m√°quina virtual <i class="fa fa-desktop"></i></h1>
<p>√ìtimo! Agora a VM j√° deve estar pronta para uso e o jeito mais simples de utiliz√°-la √© clicando no bot√£o <img src="/post/2018-10-27-server-cloud/server-cloud_files/ssh.png" /> na p√°gina de <code>Inst√¢ncias de VMs</code> e aguardar a m√°quina iniciar</p>
<center>
<img src="/post/2018-10-27-server-cloud/server-cloud_files/vm_on.gif" style="width:80.0%" />
</center>
<p>Vamos √†s configura√ß√µes!</p>
<div id="obter-senha-para-super-usu√°rio" class="section level2">
<h2>Obter senha para super usu√°rio</h2>
<p>O primeiro passo ser√° obter a senha para usu√°rio <code>root</code></p>
<pre><code>sudo passwd</code></pre>
<p>Ap√≥s determinar a senha, alterne para este usu√°rio e conceda a permiss√£o de super usu√°rio para evitar trabalhar como <code>root</code>:</p>
<pre><code>su root
passwd gomes_fellipe1
gpasswd -a gomes_fellipe1 sudo
su gomes_fellipe1</code></pre>
<p>Agora meu usu√°rio tem permiss√£o de super usu√°rio e uma senha para utilizar para acessar o RStudio Server.</p>
</div>
<div id="exibir-sua-vm-em-um-navegador" class="section level2">
<h2>Exibir sua VM em um navegador</h2>
<p>Se voc√™ utilizar o comando</p>
<pre><code>curl ipinfo.io/ip</code></pre>
<p>o endere√ßo IP externo ser√° exibido no console, por√©m se digitar este caminho no browser ainda n√£o ser√° poss√≠vel acessar sua m√°quina. Para isso, instale o <a href="https://www.nginx.com/">Nginx</a> (que √© um servidor web leve) com os comandos:</p>
<pre><code>sudo apt-get update
sudo apt-get -y install nginx</code></pre>
<p>Agora se voc√™ digitar o endere√ßo IP externo da sua m√°quina no browser ser√° poss√≠vel ver a tela de sauda√ß√£o do nginx!</p>
</div>
<div id="criar-um-arquivo-swap" class="section level2">
<h2>Criar um arquivo swap</h2>
<p>Seguindo a recomenda√ß√£o do post <a href="http://www.simoncoulombe.com/2018/05/07/protected_free_shiny/">Implantando um servidor Shiny Server e RStudio seguro em uma m√°quina virtual gratuita do Google Cloud</a> e as instru√ß√µes do link <a href="https://digitizor.com/create-swap-file-ubuntu-linux/" class="uri">https://digitizor.com/create-swap-file-ubuntu-linux/</a>, podemos criar um arquivo <a href="https://pt.wikipedia.org/wiki/Mem%C3%B3ria_virtual">swap</a> pois a inst√¢ncia <em>f1-micro</em> n√£o tem RAM suficiente e pode ser que alguns pacotes n√£o possam ser instalados por falta de mem√≥ria.</p>
<pre><code>cd /
sudo dd if=/dev/zero of=swapfile bs=1M count=3000
sudo mkswap swapfile
sudo swapon swapfile
sudo nano etc/fstab

# Adicione a linha a seguir no arquivo que abrir
/swapfile none swap sw 0 0 
cat /proc/meminfo</code></pre>
</div>
<div id="instalar-o-r" class="section level2">
<h2>Instalar o R</h2>
<p>Para instalar o R apenas segui os passos apresentados em <a href="https://deanattali.com/2015/05/09/setup-rstudio-shiny-server-digital-ocean/" class="uri">https://deanattali.com/2015/05/09/setup-rstudio-shiny-server-digital-ocean/</a> com os c√≥digos:</p>
<pre><code>sudo sh -c &#39;echo &quot;deb http://cran.rstudio.com/bin/linux/ubuntu xenial/&quot; &gt;&gt; /etc/apt/sources.list&#39;

gpg --keyserver keyserver.ubuntu.com --recv-key E084DAB9
gpg -a --export E084DAB9 | sudo apt-key add -

sudo apt-get update
sudo apt-get -y install r-base</code></pre>
<p>Agora o R est√° pronto para uso, basta escrever <code>R</code> no console para inici√°-lo.</p>
<center>
<img src="/post/2018-10-27-server-cloud/server-cloud_files/R.png" />
</center>
<div id="depend√™ncias-e-pacotes" class="section level3">
<h3>Depend√™ncias e pacotes</h3>
<p>Antes de instalar outros pacotes podemos iniciar instalando o <code>devtools</code> pois esse pacote permite instalar a vers√£o do desenvolvedores de alguns pacotes do R que est√£o dispon√≠veis no GitHub. Para instalar as depend√™ncias do <code>devtools</code>:</p>
<pre><code>sudo apt-get -y install libcurl4-gnutls-dev libxml2-dev libssl-dev</code></pre>
<p>Tudo certo, agora j√° √© poss√≠vel instalar pacotes tanto do <a href="https://cran.r-project.org/">CRAN</a> quando do <a href="www.github.com">GitHub</a>. Al√©m do <code>devtools</code> instalaremos mais dois pacotes que ser√£o utilizados pelo aplicativo exemplo deste post:</p>
<pre><code>sudo su - -c &quot;R -e \&quot;install.packages(c(&#39;devtools&#39;,&#39;rmarkdown&#39;, &#39;quantmod&#39;), repos=&#39;http://cran.rstudio.com/&#39;)\&quot;&quot;
sudo su - -c &quot;R -e \&quot;devtools::install_github(&quot;jbkunst/highcharter&quot;)\&quot;&quot;</code></pre>
<p><strong>Importante:</strong> Note que ao instalar os pacotes do R no terminal os pacotes s√£o instalados como usu√°rio <code>root</code>, o que significa que os pacotes ser√£o instalados em uma biblioteca global e estar√£o dispon√≠veis para todos os usu√°rios da m√°quina.</p>
</div>
</div>
<div id="instalar-o-rstudio-server" class="section level2">
<h2>Instalar o RStudio Server</h2>
<p>Neste ponto j√° temos uma m√°quina virtual como R instalado e estamos preparados para dar in√≠cio ao nosso <strong>RStudio Server</strong>! Para instalar entre na p√°gina de download do RStudio em: <a href="https://www.rstudio.com/products/rstudio/download-server/" class="uri">https://www.rstudio.com/products/rstudio/download-server/</a> e siga os passos de instala√ß√£o. No meu caso bastou rodar:</p>
<pre><code>sudo apt-get install gdebi-core
wget https://download2.rstudio.org/rstudio-server-1.1.456-amd64.deb
sudo gdebi rstudio-server-1.1.456-amd64.deb</code></pre>
<p>Pronto, agora j√° possu√≠mos nosso pr√≥prio RStudio Server na nuvem! Para acess√°-lo basta utilizar a porta <code>8787</code> atrav√©s de seu IP externo (que pode ser obtido com o comando: <code>curl ipinfo.io/ip</code>, como mencionado anteriormente). Portanto, acesse algo como: <a href="http://35.237.234.123:8787" class="uri">http://35.237.234.123:8787</a> (este link direcionar√° para a m√°quina virtual que criei no exemplo deste post) e voc√™ ser√° direcionado para uma tela de login:</p>
<center>
<img src="/post/2018-10-27-server-cloud/server-cloud_files/rstudioserver.png" style="width:80.0%" />
</center>
<p>√â poss√≠vel fazer o login no RStudio Server com qualquer usu√°rio que esteja cadastrado em sua m√°quina virtual, no meu caso eu fa√ßo o login com o nome de usu√°rio <code>gomes_fellipe1</code> e a senha que defini para meu usu√°rio ao criar a m√°quina.</p>
<p>√â poss√≠vel criar um novo usu√°rio para acessar o RStudio Server via terminal da m√°quina virtual com:</p>
<pre><code>adduser novo_usuario</code></pre>
<p>Caso seu objetivo seja apenas o de ter seu pr√≥prio RStudio Server Parab√©ns! J√° est√° dispon√≠vel e pronto para uso! A seguir trataremos de como instalar e como efetuar algumas configura√ß√µes b√°sicas de um Shiny Server, mesmo que voc√™ n√£o seja desenvolvedor desse tipo de app sugiro que instale o servidor mesmo assim pois ele tamb√©m pode ser usado para hospedar seus documentos interativos como arquivos Rmarkdown!</p>
</div>
<div id="instalar-o-shiny-server" class="section level2">
<h2>Instalar o Shiny Server</h2>
<p>Aplicativos Shiny s√£o incr√≠veis e sua aplicabilidade √© tamanha que poderia dedicar uma s√©rie de posts exclusivamente para falar sobre essa ferramenta. Dedico uma enorme parte do meu tempo de trabalho atualmente no desenvolvimento de aplicativos Shiny e ao terminar todas as etapas de um <a href="http://r4ds.had.co.nz/introduction.html">‚Äút√≠pico projeto de ciencia de dados‚Äù</a> a etapa da <strong>entrega</strong> dos resultados pode ser bastante cr√≠tica e um aplicativo Shiny √© capaz de trazer interatividade √†s suas an√°lises.</p>
<p>Existem diversas op√ß√µes de entrega, entre elas:</p>
<ul>
<li>Fazer um r√°pido deploy no <a href="http://www.shinyapps.io/" class="uri">http://www.shinyapps.io/</a>;</li>
<li>Hospedar no now, como apresentado na p√°gina do <a href="https://www.curso-r.com/">curso-r</a> em: <a href="https://www.curso-r.com/blog/2018-03-05-shiny-now/" class="uri">https://www.curso-r.com/blog/2018-03-05-shiny-now/</a>;</li>
<li>Dockerizar o app com a imagem <a href="https://hub.docker.com/u/rocker/" class="uri">https://hub.docker.com/u/rocker/</a> e disponibiliz√°-lo na rede interna de sua empresa;</li>
<li>Criar um execut√°vel via R e Inno Setup (um instalador para programas do Windows), como ilustrado em: <a href="https://www.ficonsulting.com/filabs/RInno" class="uri">https://www.ficonsulting.com/filabs/RInno</a>;</li>
<li>Dentre tantas outras‚Ä¶</li>
</ul>
<p>No caso deste post, estamos criando nosso pr√≥prio servidor e assim teremos controle tanto do desempenho da m√°quina hospedada quanto do uso do Shiny Server propriamente dito.</p>
<p>Consulte a p√°gina de download do Shiny Server em: <a href="https://www.rstudio.com/products/shiny/download-server/" class="uri">https://www.rstudio.com/products/shiny/download-server/</a> para saber qual a vers√£o mais recente para instalar no seu computador (note que ser√° necess√°rio instalar o pacote do shiny como mencionado anteriormente), no meu caso foi:</p>
<pre><code>sudo su - -c &quot;R -e \&quot;install.packages(&#39;shiny&#39;, repos=&#39;https://cran.rstudio.com/&#39;)\&quot;&quot;
sudo apt-get install gdebi-core
wget https://download3.rstudio.org/ubuntu-14.04/x86_64/shiny-server-1.5.9.923-amd64.deb
sudo gdebi shiny-server-1.5.9.923-amd64.deb</code></pre>
<p>O Shiny Server est√° agora instalado e em execu√ß√£o. Supondo que correu tudo bem voc√™ j√° poder√° acessar a p√°gina inicial padr√£o do Shiny Server, que inclui algumas instru√ß√µes e dois aplicativos Shiny, veja em (na minha m√°quina de exemplo): <a href="http://35.237.234.123:3838" class="uri">http://35.237.234.123:3838</a> (Note que eu n√£o configurei um IP externo fixo neste app por se tratar de uma prova de conceito, como ele pode alterar para um IP aleat√≥rio quando eu reiniciar a m√°quina ent√£o fiz um backup no <a href="http://www.shinyapps.io/" class="uri">http://www.shinyapps.io/</a> no endere√ßo: <a href="https://gomesfellipe.shinyapps.io/app_acoes/" class="uri">https://gomesfellipe.shinyapps.io/app_acoes/</a> para manter este DEMO no caso dessa m√°quina espec√≠fica n√£o estar mais no ar futuramente)</p>
<p><img src="/post/2018-10-27-server-cloud/server-cloud_files/shinyserver.png" /></p>
<p>Alguns comandos √∫teis para configurar o status do servidor:</p>
<pre><code>sudo systemctl start shiny-server
sudo systemctl stop shiny-server
sudo systemctl restart shiny-server</code></pre>
<p><strong>Importante</strong>:</p>
<ul>
<li>O arquivo de configura√ß√£o do servidor est√° em: <code>/etc/shiny-server/shiny-server.conf</code>;</li>
<li>A p√°gina inicial do Shiny Server estar√° em: <code>/srv/shiny-server/index.html</code> (normalmente removemos esta p√°gina ou incluir um outro html para customiz√°-la);</li>
<li>Todos aplicativos Shiny com o nome <code>app.R</code> que voc√™ colocar em <code>/srv/shiny-server/</code> ser√£o entendidos pelo servidor como um aplicativo Shiny;</li>
<li>Todos aplicativos ser√£o executados como usu√°rio <code>shiny</code> o que implica que qualquer pacote necess√°rio em um aplicativo shiny dever√° estar na biblioteca global ou na biblioteca do usu√°rio <code>shiny</code>. Existem diversas formas de lidar com esse aspecto da configura√ß√£o inicial do servidor ent√£o deixarei algumas refer√™ncias ao final do post para quem tiver a necessidade de maior customiza√ß√£o e controle do servidor;</li>
<li>Para visualizar os logs durante o desenvolvimento do aplicativo ser√° necess√°rio adicionar as linhas <code>preserve_logs true;</code>e <code>sanitize_errors false;</code> ao arquivo de configura√ß√£o do servidor (e reiniciar o servidor em seguida) e assim os logs do servidor estar√£o dispon√≠veis em <code>/var/log/shiny-server.log</code>.</li>
</ul>
</div>
<div id="adicionar-aplicativos-ao-shiny-server-via-github" class="section level2">
<h2>Adicionar aplicativos ao Shiny Server via Github</h2>
<p>Como j√° foi dito, qualquer aplicativo Shiny colocado na pasta <code>/srv/shiny-server/</code> ser√° automaticamente exibido como um Shiny app na p√°gina principal do servidor. Al√©m da op√ß√£o de desenvolver um um aplicativo diretamente pelo RStudio Server e salvar nesta pasta podemos clonar algum app hospedado no <a href="https://github.com/">GitHub</a> ou no <a href="https://bitbucket.org">BitBucket</a> para esta pasta.</p>
<p>Primeiramente vamos instalar o git e realizar as configura√ß√µes iniciais:</p>
<pre><code>sudo apt-get -y install git
git config --global user.email &quot;you@example.com&quot;
git config --global user.name &quot;Your Name&quot;</code></pre>
<p>Agora vamos nos deslocar para a pasta <code>srv/shiny-server/</code> e remover a p√°gina <code>index.html</code> pois n√£o estamos mais interessados em ver a p√°gina de exemplo do Shiny Server:</p>
<pre><code>cd /srv/shiny-server
sudo rm index.html</code></pre>
<p>Em seguida j√° √© poss√≠vel clonar seu reposit√≥rio do <a href="https://github.com/">GitHub</a> ou do <a href="https://bitbucket.org">BitBucket</a> diretamente para esta pasta (Lembrete: o arquivo que executa o app deve ser nomeado como <code>app.R</code>!), veja:</p>
<pre><code>sudo git clone https://github.com/gomesfellipe/app_acoes.git</code></pre>
<p>O legal de administrar suas aplica√ß√µes via <a href="https://github.com/">GitHub</a> ou do <a href="https://bitbucket.org">BitBucket</a> √© que o c√≥digo hospedado pode ser trabalhado e ‚Äúcommitado‚Äù de qualquer outro lugar do mundo e para atualizar no servidor basta utilizar o comando <code>sudo git pull</code> na pasta do app que o diret√≥rio local ser√° atualizado com as modifica√ß√µes realizadas no reposit√≥rio remoto.</p>
<p>Pronto, se utilizar o comando <code>ls</code> j√° ser√° poss√≠vel ver a pasta clonada no diret√≥rio local:</p>
<center>
<img src="/post/2018-10-27-server-cloud/server-cloud_files/ls.png" />
</center>
<p>Ao acessar o app teremos:</p>
<center>
<iframe width="100%" height="725" scrolling="no" frameborder="no" src="https://gomesfellipe.shinyapps.io/app_acoes/">
</iframe>
</center>
<p>O c√≥digo para gerar este app √©:</p>
<script src="https://gist.github.com/gomesfellipe/f1f6469884bff2d2dce8729fd8bce719.js"></script>
<p><strong>Nota¬π</strong>: O c√≥digo do app e as depend√™ncias podem ser obtidas em: <a href="https://github.com/gomesfellipe/app_acoes" class="uri">https://github.com/gomesfellipe/app_acoes</a> e para execut√°-lo diretamente do seu terminal basta utilizar o comando:</p>
<pre class="r"><code>shiny::runGitHub(&quot;gomesfellipe/app_acoes&quot;)</code></pre>
<p><strong>Nota¬≤</strong>: Caso queira incluir seu aplicativo Shiny em alguma p√°gina Web ou relat√≥rio √© simples, utilizando um pouco de html √© s√≥ o inclu√≠ no seu arquivo RMarkdown utilizando algo parecido com:</p>
<pre><code>&lt;iframe width=&quot;450&quot; height=&quot;400&quot; scrolling=&quot;no&quot; frameborder=&quot;no&quot; src=&quot;sua_url&quot;&gt; &lt;/iframe&gt;</code></pre>
</div>
</div>
<div id="tudo-pronto" class="section level1">
<h1>Tudo Pronto? <i class="fa fa-exclamation-triangle"></i></h1>
<p>Definitivamente n√£o! Implementamos um app bem b√°sico mas existem intermin√°veis desafios que n√£o foram abordados nesse r√°pido post como a instala√ß√£o do Latex para o Shiny Server, o uso de cont√™ineres Docker, senha para os aplicativos shiny, definir um IP est√°tico, todas as outras depend√™ncias que podem ser requisitadas na instala√ß√£o de pacotes espec√≠ficos etc.. √â aquela hist√≥ria, quanto mais a gente estuda mais coisa aparece para estudar mas esse √© justamente o legal de tudo, que nunca fica f√°cil!</p>
</div>
<div id="refer√™ncias-e-sugest√µes" class="section level1">
<h1>Refer√™ncias e sugest√µes:</h1>
<ul>
<li><a href="https://cloud.google.com/getting-started/?hl=pt-br" class="uri">https://cloud.google.com/getting-started/?hl=pt-br</a></li>
<li><a href="https://support.rstudio.com/hc/en-us/articles/200552306-Getting-Started" class="uri">https://support.rstudio.com/hc/en-us/articles/200552306-Getting-Started</a></li>
<li><a href="http://rstudio.github.io/shiny-server/os/0.4.0/" class="uri">http://rstudio.github.io/shiny-server/os/0.4.0/</a></li>
<li><a href="https://deanattali.com/2015/05/09/setup-rstudio-shiny-server-digital-ocean/" class="uri">https://deanattali.com/2015/05/09/setup-rstudio-shiny-server-digital-ocean/</a></li>
<li><a href="https://datarunsdeep.com.au/blog/building-r-shiny-app-google-cloud-display-bigquery-data" class="uri">https://datarunsdeep.com.au/blog/building-r-shiny-app-google-cloud-display-bigquery-data</a></li>
<li><a href="https://shiny.rstudio.com/gallery/authentication-and-database.html" class="uri">https://shiny.rstudio.com/gallery/authentication-and-database.html</a></li>
<li><a href="http://www.simoncoulombe.com/2018/05/07/protected_free_shiny/" class="uri">http://www.simoncoulombe.com/2018/05/07/protected_free_shiny/</a></li>
<li><a href="https://www.brettory.com/2018/02/embedding-a-shiny-app-in-blogdown/" class="uri">https://www.brettory.com/2018/02/embedding-a-shiny-app-in-blogdown/</a></li>
<li><a href="https://www.keycdn.com/support/413-request-entity-too-large" class="uri">https://www.keycdn.com/support/413-request-entity-too-large</a></li>
<li><a href="https://auth0.com/blog/adding-authentication-to-shiny-server/" class="uri">https://auth0.com/blog/adding-authentication-to-shiny-server/</a></li>
<li><a href="https://gist.github.com/jjesusfilho/6a3ec38016f7e120e9a2cf2b49e42962" class="uri">https://gist.github.com/jjesusfilho/6a3ec38016f7e120e9a2cf2b49e42962</a></li>
<li><a href="https://gist.github.com/jjesusfilho/7b7001745cbb8f7b1ad36e7bfe5d43e8" class="uri">https://gist.github.com/jjesusfilho/7b7001745cbb8f7b1ad36e7bfe5d43e8</a></li>
<li><a href="https://curso-r.github.io/auth0/" class="uri">https://curso-r.github.io/auth0/</a></li>
</ul>
</div>

        <p><strong>Leia o post completo em:</strong> <a href="https://gomesfellipe.github.io/post/2018-10-27-server-cloud/server-cloud/">Seu app, RStudio e Shiny Server na nuvem do Google</a></p>
        <p><em>Este post foi originalmente publicado em <a href="https://gomesfellipe.github.io/">Fellipe Gomes - Data Science Blog</a></em></p>
      ]]></content:encoded>
      <category>Fundamentos de Data Science</category>
      <category>Intelig√™ncia Artificial</category>
      <category>Programa√ß√£o e Ferramentas</category>
      <category domain="tag">bitcoin</category>
      <category domain="tag">estatistica</category>
      <category domain="tag">google</category>
      <category domain="tag">google-cloud</category>
      <category domain="tag">pratica</category>
      <category domain="tag">r</category>
      <category domain="tag">rstudio</category>
      <category domain="tag">rstudio-server</category>
      <category domain="tag">series-temporais</category>
      <category domain="tag">servidor</category>
    </item>
    <item>
      <title>Analisando o mercado de cryptomoedas com R</title>
      <link>https://gomesfellipe.github.io/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r/analisando-o-mercado-de-cryptomoedas-com-r/</link>
      <pubDate>Mon, 04 Dec 2017 00:00:00 +0000</pubDate>
      <author>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</author>
      <guid>https://gomesfellipe.github.io/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r/analisando-o-mercado-de-cryptomoedas-com-r/</guid>
      <description>As cryptomoedas Quem acompanha os jornais j√° deve ter notado que o mercado de cryptomoedas v√™m crescendo rapidamente. Grandes canais de informa√ß√£o j√° abordam o assunto. Uma breve pesquisa no Google j√° nos retorna not√≠cia na globo, not√≠cia no site da Forbes dentre muitos outros.
Al√©m disso sua cota√ß√£o j√° pode ser acompanhada nos maiores sites de busca do mercado financeiro.
Estamos diante de muitas novidades que v√™m surgindo exponencialmente na humanidade, talvez seja interessante buscar entender e desfrutar como a programa√ß√£o pode nos ajudar nessa experi√™ncia relacionada a temas t√£o recentes.</description>
      <content:encoded>&lt;![CDATA[
        


<div id="as-cryptomoedas" class="section level1">
<h1>As cryptomoedas</h1>
<p>Quem acompanha os jornais j√° deve ter notado que o mercado de cryptomoedas v√™m crescendo rapidamente. Grandes canais de informa√ß√£o j√° abordam o assunto. Uma breve pesquisa no Google j√° nos retorna <a href="http://g1.globo.com/jornal-da-globo/noticia/2016/07/bitcoin-moeda-virtual-se-populariza-no-brasil-e-tem-valorizacao-recorde.html">not√≠cia na globo</a>, not√≠cia no <a href="http://forbes.uol.com.br/tag/bitcoin/">site da Forbes</a> dentre muitos outros.</p>
<p>Al√©m disso sua <a href="http://dolarhoje.com/bitcoin-hoje/">cota√ß√£o</a> j√° pode ser acompanhada nos maiores sites de busca do mercado financeiro.</p>
<p>Estamos diante de muitas novidades que v√™m surgindo exponencialmente na humanidade, talvez seja interessante buscar entender e desfrutar como a programa√ß√£o pode nos ajudar nessa experi√™ncia relacionada a temas t√£o recentes.</p>
<p>Portanto surge a pergunta que vem a tona: como o R pode nos ajudar a cryptomoedas?</p>
<p>Vejamos o que o que encontramos no CRAN..</p>
</div>
<div id="pacote-coinmarketcapr" class="section level1">
<h1>Pacote <code>coinmarketcapr</code></h1>
<p>Tem dispon√≠vel no <a href="https://cran.r-project.org/">CRAN</a> o pacote <a href="https://cran.r-project.org/web/packages/coinmarketcapr/index.html">coinmarketcapr</a> que nos permite extrair e monitorar o pre√ßo e o limite de mercado das cryptomoedas da API do <a href="https://coinmarketcap.com/">coinmarketcap.com</a></p>
<p>Primeiramente precisamos instalar o pacote:</p>
<pre class="r"><code>install.packages(&quot;coinmarketcapr&quot;)
library(coinmarketcapr)</code></pre>
<div id="maiores-ocorr√™ncias" class="section level3">
<h3>Maiores ocorr√™ncias</h3>
<p>O pacote conta com a fun√ß√£o <code>plot_top_5_currencies()</code> que j√° apresenta de brinde um gr√°fico de barras com as 5 principais cryptomoedas do mercado, veja:</p>
<pre class="r"><code>plot_top_5_currencies()</code></pre>
<center>
<img src="/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r_files/foto1.png" style="width:70.0%" />
</center>
</div>
<div id="detalhes-do-mercado" class="section level3">
<h3>Detalhes do mercado</h3>
<p>Os resultados ficam dispon√≠veis para quem quiser interpretar. √â importante notar que isso n√£o nos da a imagem de como o mercado est√° dividido entre v√°rias cryptomoedas, ent√£o vamos obter os dados completos de v√°rias cryptomoedas:</p>
<pre class="r"><code>mercado_hoje &lt;- get_marketcap_ticker_all()
head(mercado_hoje[,1:8])</code></pre>
<p><img src="/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r_files/foto3.png" /></p>
</div>
<div id="visualmente" class="section level3">
<h3>Visualmente</h3>
<p>Ap√≥s extrair os dados completos de v√°rias cryptomoedas, vamos visualizar essa distribui√ß√£o atrav√©s de um <code>treemap</code> com os c√≥digos:</p>
<pre class="r"><code>library(treemap)
base &lt;- na.omit(mercado_hoje[,c(&#39;id&#39;,&#39;market_cap_usd&#39;)])
base$market_cap_usd &lt;- as.numeric(base$market_cap_usd)
base$formatted_market_cap &lt;-  paste0(base$id,&#39;\n&#39;,&#39;$&#39;,format(base$market_cap_usd,big.mark = &#39;,&#39;,scientific = F, trim = T))
treemap(base, index = &#39;formatted_market_cap&#39;, vSize = &#39;market_cap_usd&#39;, title = &#39;Cryptocurrency Market Cap&#39;, fontsize.labels=c(12, 8), palette=&#39;RdYlGn&#39;)</code></pre>
<center>
<img src="/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r_files/foto2.png" style="width:80.0%" />
</center>
<p>Vou deixar as interpreta√ß√µes para os analistas de mercado, mas como um cientista de dados, muitos (muitos mesmo) insights podem ser extra√≠dos dos dados acima e pode ser interessante analisar esse mercado</p>
</div>
</div>
<div id="pacote-jsonlite-para-avaliar-bitcoins" class="section level1">
<h1>Pacote <code>jsonlite</code> para avaliar Bitcoins</h1>
<p>O <a href="https://cran.r-project.org/web/packages/jsonlite/index.html">pacote jsonlite dispon√≠vel no CRAN</a> tr√°s s√©rie de recursos flex√≠veis, robustos e de alto desempenho para trabalhar o R com JSON conjuntamente. O pacote √© capaz de interagir com API da Web e isso vai ser o recurso que precisamos aqui.</p>
<p>Trazendo o foco para os Bitcoins, existe mais de uma maneira de se extrair os dados do mercado que possam trazer grandes insights. Vamos conferir aqui como este pacote pode ajudar nesta tarefa.</p>
<p>Inicialmente precisamos instalar e carregar o pacote:</p>
<pre class="r"><code>#install.packages(&quot;jsonlite&quot;)
library(jsonlite)
suppressMessages(library(tidyverse)) #Para manipula√ß√£o de dados</code></pre>
<p>Com o pacote carregado j√° podemos realizar uma consulta diretamente de dentro do R com o comando <code>safe_fromJSON()</code>.</p>
<p>Os pre√ßos da bitcoin s√£o fornecidos pela API da <a href="https://blinktrade.com/">BlinkTrad</a> que √© bem simples usar, basta pegar o json que a url do c√≥digo abaixo solta.</p>
<p>Aproveito e dou um tapinha para deixar em forma de data.frame e com a data de consulta junto.</p>
<pre class="r"><code>safe_fromJSON = safely(fromJSON, as.numneric(NA))
nova_consulta_list = safe_fromJSON(&quot;http://api.blinktrade.com/api/v1/BRL/ticker?crypto_currency=BTC&quot;)

nova_consulta = nova_consulta_list$result %&gt;%
  as.tibble %&gt;%
  mutate(timestamp = lubridate::now())

nova_consulta</code></pre>
<div id="loop-infinito-para-acompanhar-os-pre√ßo" class="section level3">
<h3>Loop infinito para acompanhar os pre√ßo</h3>
<p>Existe um universo de infinitas possibilidades para acompanhar estes dados, trago aqui um loop infinito <code>(while(TRUE))</code> composto por um , um data.frame hist√≥rico.RData, um tempo entre uma consulta e outra (30 segundos por padr√£o) e a consulta propriamente dita. Veja:</p>
<pre class="r"><code>#Inicializa o historico.RData
historico = nova_consulta
save(historico, file = &quot;historico.RData&quot;)</code></pre>
<p>Dando in√≠cio ao loop:</p>
<pre class="r"><code>  #loop infinito
  while(TRUE){
    #pega a cotacao do bitcoin brasil (BTCBRL) da API do blinktrade
    nova_consulta_list = safe_fromJSON(&quot;http://api.blinktrade.com/api/v1/BRL/ticker?crypto_currency=BTC&quot;)
  
    #verifica se a API retornou uma lista
    if(&quot;list&quot; %in% class(nova_consulta_list$result)){
      nova_consulta = nova_consulta_list$result %&gt;%
        as.tibble %&gt;%
        mutate(timestamp = lubridate::now())
      #
      #
      # espaco reservado para as regras!
      #
      #
      #guarda a consulta
      historico = bind_rows(historico, nova_consulta)
      save(historico, file = &quot;historico.RData&quot;)
    }
    #condicoes
    #Exemplo:
    #if(nova_consulta$buy &gt; 14600 &amp; nova_consulta$last &lt; 14500){
    #
    #Fazer alguma coisa
    #
    #
    #}
  }</code></pre>
<p>Tamb√©m podemos acompanhar graficamente incluindo um gr√°fico dentro do loop, veja:</p>
<pre class="r"><code>while(TRUE){
    #pega a cotacao do bitcoin brasil (BTCBRL) da API do blinktrade
    nova_consulta_list = safe_fromJSON(&quot;http://api.blinktrade.com/api/v1/BRL/ticker?crypto_currency=BTC&quot;)
  
    #verifica se a API retornou uma lista
    if(&quot;list&quot; %in% class(nova_consulta_list$result)){
      nova_consulta = nova_consulta_list$result %&gt;%
        as.tibble %&gt;%
        mutate(timestamp = lubridate::now())
      
      #
      #
      # espaco reservado para as regras!
      #
      #
      
      #guarda a consulta
      historico = bind_rows(historico, nova_consulta)
      save(historico, file = &quot;historico.RData&quot;)
    }
    
    #Cria um gr√°fico;
    
    ggplot(historico %&gt;%
                 gather(indicador, valor, high, low, buy, sell, last))+
      geom_line(aes(x=timestamp, y=valor, color=indicador))
    
    #condicoes
    #if(nova_consulta$buy &gt; 14600 &amp; nova_consulta$last &lt; 14500){
    #
    # Fazer alguma coisa
    #
    #}
    
    
  }</code></pre>
<p>Este gr√°fico retornar√° algo como:</p>
<center>
<img src="/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r_files/foto4.png" style="width:70.0%" />
</center>
<p>Este gr√°fico ser√° atualizado em tempo real!</p>
</div>
</div>

        <p><strong>Leia o post completo em:</strong> <a href="https://gomesfellipe.github.io/post/2017-12-04-analisando-o-mercado-de-cryptomoedas-com-r/analisando-o-mercado-de-cryptomoedas-com-r/">Analisando o mercado de cryptomoedas com R</a></p>
        <p><em>Este post foi originalmente publicado em <a href="https://gomesfellipe.github.io/">Fellipe Gomes - Data Science Blog</a></em></p>
      ]]></content:encoded>
      <category>R</category>
      <category>Pr√°tica</category>
      <category>Bitcoin</category>
      <category>S√©ries Temporais</category>
      <category domain="tag">Correlacoes</category>
      <category domain="tag">gomesfellipe</category>
      <category domain="tag">bitcoin</category>
      <category domain="tag">cryptomoedas</category>
      <category domain="tag">R</category>
      <category domain="tag">RStudio</category>
      <category domain="tag">S√©ries Temporais</category>
    </item>
  </channel>
</rss>