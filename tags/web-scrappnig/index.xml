&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>web-scrappnig on Fellipe Gomes - Data Science Blog</title>
    <link>https://gomesfellipe.github.io/tags/web-scrappnig/</link>
    <description>√öltimos posts sobre Data Science, Machine Learning e R</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>pt-br</language>
    <managingEditor>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</managingEditor>
    <webMaster>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</webMaster>
    <lastBuildDate>Fri, 03 Dec 2021 00:00:00 +0000</lastBuildDate>
    <atom:link href="https://gomesfellipe.github.io/tags/web-scrappnig/" rel="self" type="application/rss+xml" />
    <item>
      <title>Vou te provar que da para fazer Grafos bonitos em R!</title>
      <link>https://gomesfellipe.github.io/post/2021-12-03-grafos-em-r/</link>
      <pubDate>Fri, 03 Dec 2021 00:00:00 +0000</pubDate>
      <author>gomes.fellipe1@gmail.com (Fellipe Carvalho Gomes)</author>
      <guid>https://gomesfellipe.github.io/post/2021-12-03-grafos-em-r/</guid>
      <description>Neste post vamos coletar not√≠cias via web scrapping, detectar entidades dos textos e criar um grafo utilizando ggplot2</description>
      <content:encoded>&lt;![CDATA[
        

<div id="TOC">
<ul>
<li><a href="#introdu%C3%A7%C3%A3o-e-contexto" id="toc-introdu√ß√£o-e-contexto">Introdu√ß√£o e contexto</a>
<ul>
<li><a href="#o-que-s%C3%A3o-grafos" id="toc-o-que-s√£o-grafos">O que s√£o Grafos?</a></li>
<li><a href="#como-contruir-um" id="toc-como-contruir-um">Como contruir um?</a></li>
</ul></li>
<li><a href="#carregar-depend%C3%AAncias" id="toc-carregar-depend√™ncias">Carregar depend√™ncias</a></li>
<li><a href="#fonte-dos-dados" id="toc-fonte-dos-dados">Fonte dos dados</a></li>
<li><a href="#ner---named-entity-recognition" id="toc-ner---named-entity-recognition">NER - Named Entity Recognition</a></li>
<li><a href="#preparar-dados" id="toc-preparar-dados">Preparar dados</a></li>
<li><a href="#b%C3%B4nus" id="toc-b√¥nus">B√¥nus</a></li>
<li><a href="#conclus%C3%A3o" id="toc-conclus√£o">Conclus√£o</a></li>
<li><a href="#outras-bibliotecas-para-constru%C3%A7%C3%A3o-de-grafos" id="toc-outras-bibliotecas-para-constru√ß√£o-de-grafos">Outras bibliotecas para constru√ß√£o de grafos</a></li>
</ul>
</div>

<div id="introdu√ß√£o-e-contexto" class="section level1">
<h1>Introdu√ß√£o e contexto</h1>
<p>Durante os anos de 2020 e 2021 fiz um <a href="https://educacao-executiva.fgv.br/df/brasilia/cursos/mba-pos-graduacao/mba-presencial/mba-executivo-em-business-analytics-e-big-data">MBA Executivo em Business Analytics e Big Data</a> na FGV e uma das disciplinas que gostei bastante abordou a an√°lise de m√≠dias sociais com t√©cnicas de minera√ß√£o de texto e processamento de linguagem natural.</p>
<p>No trabalho final fomos desafiados a extrair dados da internet via api ou scraping, aplicar a metodologia apropriada para extrair informa√ß√µes de interesse e contruir um Grafo.</p>
<p>Como esse gr√°fico deu mais de trabalho do que eu esperava e fiquei bem satisfeito com o resultado final, resolvi fazer uma nova an√°lise para praticar e publicar aqui no blog, espero que gostem!</p>
<div id="o-que-s√£o-grafos" class="section level2">
<h2>O que s√£o Grafos?</h2>
<p>üìé Segundo o Wikipedia:</p>
<blockquote>
<p>‚ÄúA teoria dos grafos √© um ramo da matem√°tica que estuda as rela√ß√µes entre os objetos de um determinado conjunto‚Äù</p>
</blockquote>
<p>S√£o muito √∫teis para an√°lises de redes sociais, redes de amizades ou qualquer rede com rela√ß√µes de depend√™ncias. Existem muitos tipos de grafos como conectados, desconectados, esparsos, densos, direcionados, n√£o direcionados e por ai vai‚Ä¶</p>
<p>Al√©m disso existe toda uma nomenclatura espec√≠fica, mas n√£o entrarei em detalhes te√≥ricos neste post pois tamb√©m estou estudado sobre o tema! Caso queira aprofundar na teoria por tr√°s recomendo <a href="http://faculty.ucr.edu/~hanneman/nettext/index.html">este material</a> gratuito muito bom!</p>
</div>
<div id="como-contruir-um" class="section level2">
<h2>Como contruir um?</h2>
<p>No curso que fiz aprendemos a mexer no <a href="https://gephi.org/">Gephi</a> para a contru√ß√£o desses Grafos (ferramenta incr√≠vel, diga-se de passagem) por√©m ouvi dizer diversas vezes, tanto dentro quanto fora da FGV, que R e Python eram muito limitados para constru√ß√£o de Grafos bonitos e que esse software sempre a melhor op√ß√£o.</p>
<p>Apesar do enorme potencial do Gephi, fiquei um pouco entediado estudando-o pois n√£o sou grande f√£ de ferramentas <em>point-and-click</em> e quando o professor falou que a escolha da ferramenta para a constru√ß√£o do Grafo era livre, resolvi tentar faz√™-lo em R!</p>
</div>
</div>
<div id="carregar-depend√™ncias" class="section level1">
<h1>Carregar depend√™ncias</h1>
<p>Pacotes utilizados neste post:</p>
<pre class="r"><code>library(rvest)     # web scrapping
library(dplyr)     # manipulate data
library(purrr)     # functional prog
library(stringr)   # str toolkit
library(spacyr)    # ner
library(igraph)    # base graph
library(tidygraph) # tidy graph
library(ggraph)    # plot graph</code></pre>
</div>
<div id="fonte-dos-dados" class="section level1">
<h1>Fonte dos dados</h1>
<p>Os dados utilizados neste post foram coletados via web scrapping do site do <a href="https://g1.globo.com/">G1 - Globo</a>. Optei por trabalhar com textos jornal√≠sticos neste post pois apresentam a vantagem de serem bem escritos, o que facilita na tarefa de minera√ß√£o de texto.</p>
<p>Tamb√©m fiz um grafo analisando tweets sobre a CPI da pandemia <a href=".#b%C3%B4nus">que ser√° apresentado como b√¥nus no final deste post</a> e para quem tiver curiosidade de conferir <a href="https://github.com/gomesfellipe/cpi_da_pandemia">os c√≥digos</a> vai notar que foi necess√°rio um tratamento muito mais extensivo para corrigir os nomes de cada um dos senadores, deputados e personagens pol√≠ticos detectados.</p>
<p>Confira abaixo todos os c√≥digos necess√°rios para realizar tal extra√ß√£o:</p>
<details>
<summary>
(<em>Clique aqui para exibir as fun√ß√µes <code>scrape_post_links</code> e <code>scrape_post_body</code> </em>)
</summary>
<pre class="r"><code># Funcao para coletar os links de cada noticia
scrape_post_links &lt;- function(site) {
  cat(paste0(site, &quot;\n&quot;))
  
  source_html &lt;- read_html(site)
  
  links &lt;- source_html %&gt;%
    html_nodes(&quot;div.widget--info__text-container&quot;) %&gt;%
    html_nodes(&quot;a&quot;) %&gt;%
    html_attr(&quot;href&quot;)
  
  links &lt;- links[!is.na(links)]
  
  return(links)
}

# Funcao para coletar o texto da materia em cada link
scrape_post_body &lt;- function(site) { 
  
  text &lt;- tryCatch({
    cat(paste0(site, &quot;\n&quot;))
    body &lt;- site %&gt;%
      read_html %&gt;%
      html_nodes(&quot;article&quot;) %&gt;%
      html_nodes(&quot;p.content-text__container&quot;)  %&gt;%
      html_text %&gt;% 
      paste(collapse = &#39;&#39;)
    
  }, error = function(e){
    cat(paste(&quot;ERRO 404&quot;, &quot;\n&quot;))
    body &lt;- NA
  })
  
  return(body)
}

# criar matriz de adjacencias
get_adjacent_list &lt;- function(edge_list) {
  gtools::combinations(length(edge_list), 2, edge_list)  
}</code></pre>
</details>
<p>¬†</p>
<pre class="r"><code># raiz
root &lt;- &quot;https://g1.globo.com/busca/?q=economia+brasil&quot;

# gerar links das proximas 100 paginas
all_pages &lt;- c(root, paste0(root, &quot;&amp;page=&quot;, 1:50))

# coletar os links dos posts de cada pagina
all_links &lt;- map(all_pages, scrape_post_links) %&gt;% unlist()

# extrair urls
cleaned_links &lt;- map_chr(all_links, ~{
  .x %&gt;% 
    urltools::param_get() %&gt;% 
    pull(u) %&gt;% 
    urltools::url_decode()
})

# reter apenas links que falam de economia
cleaned_links &lt;- cleaned_links %&gt;% .[str_detect(.,  &quot;g1.globo.com/economia&quot;)]

# nao reter links do globoplay
cleaned_links &lt;- cleaned_links %&gt;% .[!str_detect(.,  &quot;globoplay&quot;)]

# coletar conteudo de cada link
data &lt;- map_chr(cleaned_links, scrape_post_body) %&gt;% unique()</code></pre>
</div>
<div id="ner---named-entity-recognition" class="section level1">
<h1>NER - Named Entity Recognition</h1>
<p>Utilizaremos um modelo de reconhecimento de entidades pr√©-treinado fornecido pela <a href="https://spacy.io/">Spacy</a> (que fornece essa e muitas outras solu√ß√µes interessantes quando se trata de processamento de linguagem natural).</p>
<p>Primeiramente vamos configurar o <code>spacyr</code> na m√°quina para utilizar o modelo pr√© treinado para reconhecimento de entidades em portugu√™s:</p>
<pre class="r"><code># Executar apenas 1 vez
spacyr::spacy_install()
spacy_download_langmodel(&quot;pt_core_news_sm&quot;)</code></pre>
<p>Inicializar modelo pr√©-treinado em portugu√™s:</p>
<pre class="r"><code>spacy_initialize(model=&quot;pt_core_news_sm&quot;)</code></pre>
<p>Aplicar modelo carregado para o reconhecimento de entidades:</p>
<pre class="r"><code>entities &lt;- spacy_extract_entity(data)</code></pre>
<p>Filtrar apenas entidades cujo tipo s√£o <strong>pessoas</strong> ou <strong>organiza√ß√µes</strong>:</p>
<pre class="r"><code>filtered_entities &lt;- 
  entities %&gt;% 
  filter(ent_type==&#39;ORG&#39;| ent_type==&#39;PER&#39;)</code></pre>
</div>
<div id="preparar-dados" class="section level1">
<h1>Preparar dados</h1>
<p>Precisamos criar uma lista de arestas:</p>
<pre class="r"><code>edges &lt;- 
  filtered_entities %&gt;%
  group_by(doc_id) %&gt;%
  summarise(entities = paste(text, collapse = &quot;,&quot;)) %&gt;% 
  pull(entities) %&gt;% 
  str_split(&quot;,&quot;) %&gt;% 
  map(~unique(unlist(.x))) %&gt;% 
  .[map_dbl(., length) != 1]</code></pre>
<p>Agora criaremos a matriz de adjac√™ncias, que envolvem todas as combina√ß√µes 2 a 2 das entidades detectadas em cada not√≠cia:</p>
<pre class="r"><code>adjacent_matrix &lt;-
  map_dfr(edges, ~ as.data.frame(get_adjacent_list(.x))) %&gt;% 
  as_tibble() %&gt;% 
  set_names(c(&#39;item1&#39;, &#39;item2&#39;))</code></pre>
<p>Aplicaremos algum tratamento para padronizar as entidades, reter apenas combina√ß√µes que aconteceram pelo menos 3 vezes e remover algum res√≠duo que veio no processo de NER:</p>
<pre class="r"><code># Padronizar entidades
adjacent_matrix &lt;- adjacent_matrix %&gt;% 
  mutate_all(~.x %&gt;% 
               str_replace_all(&quot;Funda√ß√£o Getulio Vargas&quot;, &quot;FGV&quot;) %&gt;% 
               str_replace_all(&quot;FMI&quot;, &quot;Fundo Monet√°rio Internacional&quot;) %&gt;% 
               str_replace_all(&quot;Paulo Guedes&quot;, &quot;Guedes&quot;) %&gt;% 
               str_replace_all(&quot;Estados Unidos( da Am[√©e]rica)?&quot;, &quot;EUA&quot;) %&gt;% 
               str_replace_all(&quot;Donald Trump&quot;, &quot;Trump&quot;) %&gt;% 
               str_replace_all(&quot;CEF&quot;, &quot;Caixa Econ√¥mica Federal&quot;) %&gt;% 
               str_replace_all(&quot;CMN&quot;, &quot;Conselho Monet√°rio Nacional&quot;) %&gt;% 
               str_replace_all(&quot;Cl[√°a]udio Considera&quot;, &quot;Cl√°udio&quot;) %&gt;% 
               str_replace_all(&quot;OCDE&quot;, &quot;Organiza√ß√£o para a Coopera√ß√£o e
                               Desenvolvimento Econ√¥mico&quot;) %&gt;% 
               str_replace_all(&quot;(Andr√© )?Brand√£o&quot;, &quot;Andr√© Brand√£o&quot;) %&gt;% 
               str_replace_all(&quot;(Maur[i√≠]cio )?Macri&quot;, &quot;Mauricio Macri&quot;) %&gt;% 
               str_remove_all(&quot;^(?i)(no|de)\\s&quot;)
             
             )

# remover residuos
{
  entities_to_drop &lt;- c(&quot;Assine&quot;, &quot;Google Podcasts&quot;, &quot;Spotify&quot;, &quot;Focus do&quot;,
                        &quot;Focus&quot;, &quot;Segundo&quot;, &quot;Ningu√©m&quot;, &quot;Haver√°&quot;, &quot;G1&quot;,
                        &quot;Come√ßa&quot;, &quot;LEIA&quot;, &quot;R$&quot;, &quot;Considera&quot;, &quot;Caixa Aqui&quot;)
  
  weighted_edgelist &lt;- adjacent_matrix %&gt;%
    filter_at(1:2, ~ !.x %in% entities_to_drop) %&gt;% 
    group_by(item1, item2) %&gt;%
    summarise(n=n()) %&gt;% 
    ungroup() %&gt;% 
    filter(n&gt;3) 
}</code></pre>
<p>Definir alguns objetos para o grafo:</p>
<pre class="r"><code># Instanciar objeto das setas
a &lt;- grid::arrow(type = &quot;closed&quot;, length = unit(.15, &quot;inches&quot;))

# Definir pesos conforme numero de ocorrencias
subt &lt;- weighted_edgelist

# Instanciar objeto dos vertices
vert &lt;- subt %&gt;% 
  tidyr::gather(item, word, item1, item2) %&gt;%
  group_by(word) %&gt;% 
  summarise(n = sum(n))

# Obter componentes para colorir os clusters do grafo
tidy_graph_components &lt;- 
  subt  %&gt;%
  select(item1, item2) %&gt;% 
  as.matrix() %&gt;%
  graph.edgelist(directed = FALSE)  %&gt;%
  as_tbl_graph() %&gt;% 
  activate(&quot;edges&quot;) %&gt;% 
  # definir pesos como numero de ocorrencias
  mutate(weight = subt$n) %&gt;% 
  activate(&quot;nodes&quot;) %&gt;% 
  # obter clusters:
  mutate(component = as.factor(tidygraph::group_edge_betweenness()))
  # outros tipos de agrupamentos:
  # tidygraph.data-imaginist.com/reference/group_graph.html 
  
# Atualizar vertice para incluir grupos
vert &lt;- vert %&gt;% 
  left_join( as.data.frame(activate(tidy_graph_components, &quot;nodes&quot;)) %&gt;% 
               rename(word = name))</code></pre>
<p>Finalmente, vamos criar o grafo utilizando <code>ggplot2</code>:</p>
<pre class="r"><code>set.seed(1)
subt %&gt;%
  graph_from_data_frame(vertices = vert) %&gt;%
  # https://www.data-imaginist.com/2017/ggraph-introduction-layouts/ # layouts
  ggraph(layout = &quot;fr&quot;) +
  geom_edge_link(aes(edge_alpha = n, edge_width = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, &#39;inches&#39;), color = &quot;#D9D9D9A0&quot;) +
  geom_node_point() + 
  geom_node_text(aes(label = name, size = n, alpha = n, color = component),# color = &quot;#EAFF00&quot;,
                 repel = TRUE, point.padding = unit(0.2, &quot;lines&quot;),
                 show.legend = F) +
  scale_size(range = c(2,10)) +
  scale_alpha(range = c(0.5,1))+ 
  theme_dark() + 
  theme(
    panel.background = element_rect(fill = &quot;#2D2D2D&quot;),
    legend.key = element_rect(fill = &quot;#2D2D2D&quot;)
  ) +
  theme_graph(background = &quot;black&quot;)</code></pre>
<center>
<img src="/post/2021-12-03-grafos-em-r/grafo.png" style="width:95.0%" />
</center>
<p>üìå Interpreta√ß√£o</p>
<p>Este grafo resume algumas informa√ß√µes interessantes sobre como o cen√°rio da economia no brasil estava no dia 30 de novembro de 2021. Vejamos alguns pontos relevantes que podem ser envontrados no cen√°rio atual:</p>
<div class="w3-panel w3-pale-green w3-border">
<p>¬† ‚òû Bolsa familia</p>
<p>O Aux√≠lio Brasil √© referido como o ‚ÄúNovo Bolsa Fam√≠lia‚Äù pelos jornais e por isso deve ter sido criada tal rela√ß√£o no Grafo. J√° a Caixa Econ√¥mica Federal √© o agente que executa os pagamentos.</p>
</div>
<div class="w3-panel w3-pale-red w3-border">
<p>¬† ‚òû Guedes</p>
<p>Paulo Guedes √© nosso atual ministro da economia e envolta de seu nome aparecem diversos assuntos que est√£o em pauta atualmente como a PEC dos precat√≥rios, (a privatiza√ß√£o da) Petrobr√°s, Copom, IPCA, Aux√≠lio Brasil dentre outros.</p>
</div>
<div class="w3-panel w3-pale-yellow w3-border">
<p>¬† ‚òû Fundo Monet√°rio Internacional</p>
<p>O FMI <a href="https://pt.wikipedia.org/wiki/Fundo_Monet%C3%A1rio_Internacional">trabalha para melhorar as economias dos pa√≠ses</a> e al√©m da Argentina estar endividada e em acordo com o FMI, √© √©poca de elei√ß√£o, o que explica haver alguns personagens de sua pol√≠tica relacionados.</p>
</div>
<p>Salvar localmente em alta resolu√ß√£o:</p>
<pre class="r"><code>ggsave(filename = &#39;grafo.png&#39;, width = 8, height = 6, device=&#39;png&#39;, dpi=700)</code></pre>
<p>O legal de salvar em alta resolu√ß√£o √© poder dar zoom e navegar pelo grafo!</p>
</div>
<div id="b√¥nus" class="section level1">
<h1>B√¥nus</h1>
<p>Antes de criar este post trabalhei em um <a href="https://github.com/gomesfellipe/cpi_da_pandemia">outro grafo</a> com banco de dados de aproximadamente 27GB de tweets coletados e fornecidos gentilmente pelo <a href="https://twitter.com/trifenol">Janderson Toth</a> (Para quem n√£o o conhe√ße, recomendo fortemente <a href="https://br.linkedin.com/in/trifenol">segui-lo no linkedin</a> pois ele tem compartilhado uma s√©rie de posts com insights obtidos destes dados!)</p>
<center>
<img src="/post/2021-12-03-grafos-em-r/grafo2.png" style="width:95.0%" />
</center>
<p>Para quem tiver interesse, o c√≥digo est√° <a href="https://github.com/gomesfellipe/cpi_da_pandemia">dispon√≠vel no github</a>!</p>
</div>
<div id="conclus√£o" class="section level1">
<h1>Conclus√£o</h1>
<p>Convenhamos que, de fato, criar um grafo no R n√£o √© uma tarefa super simples. No Gelphi √© poss√≠vel criar grafos at√© mais bonitos que este, por√©m, no longo prazo, ganhamos em produtividade e em escalabilidade pois poder√≠amos reaproveitar muito c√≥digo e tranquilamente desenvolver uma rotina para criar novos grafos a partir de dados streaming, por exemplo, automatizando todo o processo!</p>
</div>
<div id="outras-bibliotecas-para-constru√ß√£o-de-grafos" class="section level1">
<h1>Outras bibliotecas para constru√ß√£o de grafos</h1>
<p>Depois de conversar com algumas pessoas que leram o post, achei que merecia um update com mais id√©ias de mais bibliotecas que poderiam ter sido utilizadas:</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/cheddar/vignettes/PlotsAndStats.pdf">cheddar</a></li>
<li><a href="https://cran.r-project.org/web/packages/bipartite/bipartite.pdf">bipartite</a></li>
<li><a href="https://pedroj.github.io/bipartite_plots/">ggbipart</a></li>
<li><a href="https://rich-iannone.github.io/DiagrammeR/">diagrameR</a></li>
<li><a href="https://cran.r-project.org/web/packages/visNetwork/vignettes/Introduction-to-visNetwork.html">visNetwork</a></li>
</ul>
</div>

        <p><strong>Leia o post completo em:</strong> <a href="https://gomesfellipe.github.io/post/2021-12-03-grafos-em-r/">Vou te provar que da para fazer Grafos bonitos em R!</a></p>
        <p><em>Este post foi originalmente publicado em <a href="https://gomesfellipe.github.io/">Fellipe Gomes - Data Science Blog</a></em></p>
      ]]></content:encoded>
      <category>Fundamentos de Data Science</category>
      <category>Intelig√™ncia Artificial</category>
      <category>Programa√ß√£o e Ferramentas</category>
      <category>Texto e NLP</category>
      <category domain="tag">data-mining</category>
      <category domain="tag">estatistica</category>
      <category domain="tag">ggplot2</category>
      <category domain="tag">grafo</category>
      <category domain="tag">r</category>
      <category domain="tag">rstudio</category>
      <category domain="tag">strings</category>
      <category domain="tag">text-mining</category>
      <category domain="tag">tidyverse</category>
      <category domain="tag">web-scrappnig</category>
    </item>
  </channel>
</rss>